<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Together We Are One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- PNG Export -->
  <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>

  <style>
    :root{
      --bg0:#0b0d12;
      --bg1:#121526;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);

      --ghost: rgba(255,255,255,0.22);
      --text: rgba(255,255,255,0.92);
      --warm: rgba(255,220,170,0.95);

      /* === MAP TUNING (dein "von Hand" Regler) === */
      --map-brightness: 0.92;   /* kleiner = dunkler */
      --map-contrast: 1.10;
      --map-saturate: 0.95;

      --shade-opacity: 0.50;    /* dunkler Film/Vignette: 0..1 */
    }

    html,body { height:100%; }
    body{
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 50% 12%, rgba(40,60,110,0.35) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(900px 520px at 20% 8%, rgba(130,90,40,0.18) 0%, rgba(0,0,0,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Inter", "Segoe UI", Arial, sans-serif;
      overflow-x: hidden;
    }

    .wrap{
      min-height: 100%;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 14px;
      padding: 18px 14px 18px 14px;
      box-sizing: border-box;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* --- Prompter --- */
    .teleprompter{
      padding: 18px 18px 14px 18px;
      border-radius: 20px;
      background: linear-gradient(180deg, var(--card2), var(--card));
      border: 1px solid var(--stroke);
      box-shadow: 0 16px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
    }

    .tp-text{
      text-align: center;
      font-size: clamp(18px, 2.5vw, 30px);
      line-height: 1.45;
      letter-spacing: 0.2px;
      margin: 0;
      padding: 8px 10px 10px 10px;
      min-height: 3.2em;
    }

    .{
  color: var(--ghost);
  transition: color 160ms ease, filter 160ms ease;
  white-space: normal;      /* <-- Umbrechen erlauben */
  overflow-wrap: anywhere;  /* <-- verhindert „zu lange Wörter“ */
}
.tp-space{
  white-space: pre;         /* <-- Leerzeichen exakt halten */
}
    .tp-word.done{ color: var(--warm); filter: drop-shadow(0 0 12px rgba(255,210,140,0.18)); }
    .tp-word.active{ color: rgba(255,245,235,0.98); filter: drop-shadow(0 0 18px rgba(255,210,140,0.26)); }

    .tp-meta{ display:flex; align-items:center; justify-content:center; gap: 10px; margin-top: 8px; user-select:none; }
    .tp-btn{
      width: 42px; height: 42px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.85);
      cursor: pointer;
      transition: background 140ms ease, transform 140ms ease;
      font-size: 18px; font-weight: 700;
    }
    .tp-btn:hover{ background: rgba(255,255,255,0.10); transform: translateY(-1px); }
    .tp-progress{ width: min(520px, 62vw); height: 8px; border-radius: 8px; overflow:hidden; background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.08); }
    .tp-progress-bar{ height:100%; width: 0%; background: linear-gradient(90deg, rgba(255,220,170,0.65), rgba(255,255,255,0.55)); transition: width 220ms ease; }

    /* --- Map --- */
    .mapWrap{
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 16px 60px rgba(0,0,0,0.35);
      background: #0a0b10;
    }
    #map{ width: 100%; height: min(62vh, 520px); }

    .leaflet-tile{
      filter: brightness(var(--map-brightness)) contrast(var(--map-contrast)) saturate(var(--map-saturate));
    }

    .mapShade{
      pointer-events:none;
      position:absolute; inset:0;
      opacity: var(--shade-opacity);
      background:
        radial-gradient(900px 420px at 50% 10%, rgba(0,0,0,0.10), rgba(0,0,0,0.55) 65%),
        linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.40));
      mix-blend-mode: multiply;
    }

    .hud{
      position:absolute;
      left: 12px;
      top: 12px;
      display:flex;
      gap: 10px;
      z-index: 500;
      flex-wrap: wrap;
      align-items: center;
    }
    .hud button{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: background 140ms ease, transform 140ms ease;
      font-weight: 650;
      letter-spacing: 0.2px;
    }
    .hud button:hover{ background: rgba(0,0,0,0.30); transform: translateY(-1px); }

    .hud .sliderBox{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.85);
      font-weight: 650;
    }
    .hud input[type="range"]{
      width: 140px;
    }

    .hint{ text-align:center; margin: 4px 0 0 0; color: rgba(255,255,255,0.60); font-size: 14px; }
    .status{ text-align:center; color: rgba(255,255,255,0.70); font-size: 13px; margin-top: 6px; }

    @media (max-width: 600px){
      .wrap{ padding: 12px 10px; }
      .teleprompter{ padding: 14px 12px 12px 12px; border-radius: 18px; }
      .tp-btn{ width: 40px; height: 40px; border-radius: 14px; }
      #map{ height: 52vh; }
      .hud input[type="range"]{ width: 110px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="teleprompter" aria-label="Text">
      <p class="tp-text" id="tp-text"></p>
      <div class="tp-meta">
        <button class="tp-btn" id="tp-prev" title="Zurück" aria-label="Zurück">←</button>
        <div class="tp-progress"><div class="tp-progress-bar" id="tp-bar"></div></div>
        <button class="tp-btn" id="tp-next" title="Weiter" aria-label="Weiter">→</button>
      </div>
    </div>

    <div class="mapWrap">
      <div class="hud">
        <button id="btnWorld" title="Alle Lichter zeigen">Weltansicht</button>
        <button id="btnCard" title="PNG der Weltansicht erzeugen">Karte generieren</button>

        <!-- Dunkel-Regler -->
        <div class="sliderBox" title="Dunkelheit der Karte">
          Dunkel
          <input id="shadeSlider" type="range" min="0" max="100" value="50" />
        </div>
      </div>

      <div id="map"></div>
      <div class="mapShade" id="mapShade"></div>
    </div>

    <p class="hint">Klicke auf die Karte, um dein Licht zu setzen oder zu verschieben. (Nur ein Licht pro Browser.)</p>
    <p class="status" id="status"></p>
  </div>

<script>
/* -------------------------
   PROMPTER: Wörter bleiben nach Highlight warm ("bauen sich auf")
-------------------------- */
const tpTexts = [
  "Manchmal schauen wir in den Himmel.",
  "Vielleicht sehen wir einen Stern, den Mond, ferne Galaxien.",
  "Für einen Moment wird uns bewusst, wie klein unser Planet ist.",
  "Wie selten – vielleicht sogar einzigartig – das Leben hier ist.",
  "Auf diesem winzigen Punkt im Weltall teilen wir unser Leben.",
  "Jeder von uns mit einer eigenen Geschichte, aber doch alle miteinander verbunden.",
  "Nicht durch Herkunft, Sprache oder Grenzen – sondern durch das Glück, gemeinsam hier zu sein.",
  "Manche Menschen spüren in solchen Momenten, dass wir eigentlich eine einzige Gemeinschaft sind.",
  "Dass uns mehr verbindet als trennt.",
  "Hast du das auch schon einmal gefühlt?",
  "Helf’ uns, dieses Gefühl sichtbar zu machen!"
];

const WORD_MS = 240;
const SENTENCE_PAUSE = 900;

let tpIndex = 0;
let tpWordIdx = 0;
let tpTimer = null;

const tpTextEl = document.getElementById("tp-text");
const tpBarEl  = document.getElementById("tp-bar");

function renderSentence(sentence){
  const tokens = sentence.split(/(\s+)/); // Worte + Leerzeichen behalten

  tpTextEl.innerHTML = tokens.map(t => {
    if (/^\s+$/.test(t)) {
      return `<span class="tp-space">${t}</span>`;   // Spaces separat
    }
    return `<span class="tp-word">${t}</span>`;
  }).join("");
}

function markProgress(activeWordIdx){
  const wordSpans = Array.from(tpTextEl.querySelectorAll(".tp-word"));

  wordSpans.forEach((w, i) => {
    w.classList.remove("active");
    if (i <= activeWordIdx) w.classList.add("done");
    else w.classList.remove("done");
  });

  if (wordSpans[activeWordIdx]) wordSpans[activeWordIdx].classList.add("active");
}

function updateProgress(){
  tpBarEl.style.width = `${100 * (tpIndex + 1) / tpTexts.length}%`;
}

function playSentence(idx, auto=true){
  clearInterval(tpTimer);
  tpIndex = idx;
  tpWordIdx = 0;
  renderSentence(tpTexts[tpIndex]);
  updateProgress();

  const words = tpTexts[tpIndex].split(/\s+/).filter(Boolean);
  markProgress(0);

  tpTimer = setInterval(() => {
    tpWordIdx++;
    if (tpWordIdx < words.length){
      markProgress(tpWordIdx);
    } else {
      clearInterval(tpTimer);
      markProgress(words.length - 1);
      if(auto){
        setTimeout(() => {
          if(tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, true);
        }, SENTENCE_PAUSE);
      }
    }
  }, WORD_MS);
}

document.getElementById("tp-next").onclick = () => {
  if(tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, false);
};
document.getElementById("tp-prev").onclick = () => {
  if(tpIndex > 0) playSentence(tpIndex - 1, false);
};

playSentence(0, true);

/* -------------------------
   MAP "von Hand" dunkler machen: Slider steuert CSS Vars
-------------------------- */
const shadeSlider = document.getElementById("shadeSlider");

// Mapping: Slider 0..100 -> Overlay 0.15..0.85 und Tile-Brightness 1.00..0.74
function applyDarkness(v){
  const t = v / 100;

  // Overlay: bei 0 leicht sichtbar, bei 100 deutlich dunkler
  const shadeOpacity = 0.15 + t * 0.80;       // 0.15 .. 0.85
  // Tiles: bei 0 fast normal, bei 100 dunkler
  const brightness = 1.00 - t * 0.42;         // 1.00 .. 0.74

  document.documentElement.style.setProperty("--shade-opacity", shadeOpacity.toFixed(2));
  document.documentElement.style.setProperty("--map-brightness", brightness.toFixed(2));
}

applyDarkness(parseInt(shadeSlider.value, 10));
shadeSlider.addEventListener("input", (e) => applyDarkness(parseInt(e.target.value, 10)));

/* -------------------------
   MAP + SUPABASE
-------------------------- */
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

const SUPABASE_URL = 'https://gwfqdukbcgtcefqtgnbl.supabase.co';  // <-- DEIN Project URL
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3ZnFkdWtiY2d0Y2VmcXRnbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDU2MTMsImV4cCI6MjA4NDI4MTYxM30.ePyuDxhVoc1ol5lQ8JbRKaybgpEPozBR3Wf71oFj040';  // <-- DEIN anon public key

const statusEl = document.getElementById("status");
function setStatus(msg){ statusEl.textContent = msg || ""; }

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let session = localStorage.getItem('myLightSession');
if(!session) {
  session = uuidv4();
  localStorage.setItem('myLightSession', session);
}

const map = L.map('map', {
  zoomControl: true,
  worldCopyJump: true,
  preferCanvas: true
}).setView([20, 0], 2);

// Heller Basemap, Nacht-Look über Overlay/Filter steuerbar
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap &copy; CARTO',
  maxZoom: 18,
}).addTo(map);

const canvasRenderer = L.canvas({ padding: 0.5 });
const lightsLayer = L.layerGroup().addTo(map);

function addGlowLight(latlng, isMine=false){
  L.circleMarker(latlng, {
    renderer: canvasRenderer,
    radius: isMine ? 12 : 10,
    stroke: false,
    fill: true,
    fillOpacity: 0.18,
    fillColor: "rgba(255,220,170,1)",
    interactive: false
  }).addTo(lightsLayer);

  L.circleMarker(latlng, {
    renderer: canvasRenderer,
    radius: isMine ? 4.0 : 3.2,
    stroke: false,
    fill: true,
    fillOpacity: isMine ? 0.98 : 0.92,
    fillColor: "rgba(255,245,235,1)",
    interactive: isMine
  }).addTo(lightsLayer);
}

let allLightPoints = [];

async function loadLights() {
  try{
    setStatus("Lichter laden…");
    const { data, error } = await sb.from('lights').select('*');
    if(error) throw error;

    allLightPoints = data || [];
    lightsLayer.clearLayers();

    let mine = null;
    for (const row of allLightPoints){
      const isMine = (row.session === session);
      if(isMine) mine = row;
      addGlowLight([row.lat, row.lng], isMine);
    }

    setStatus(mine ? "Dein Licht ist gesetzt. Du kannst es durch Klicken verschieben." : "Setze dein Licht mit einem Klick auf die Karte.");
  } catch (e){
    console.error(e);
    setStatus("Konnte Lichter nicht laden. Prüfe Supabase URL/Key und Tabelle „lights“.");
  }
}

async function loadMyLight() {
  const { data } = await sb.from('lights').select('*').eq('session', session).maybeSingle();
  return data;
}

// WICHTIG: Klick verändert NICHT den Zoom (kein fitBounds, kein flyTo)
map.on('click', async function(e) {
  try{
    const existing = await loadMyLight();
    if(existing) {
      await sb.from('lights').update({lat: e.latlng.lat, lng: e.latlng.lng}).eq('session', session);
    } else {
      await sb.from('lights').insert({lat: e.latlng.lat, lng: e.latlng.lng, session});
    }
    await loadLights();
  } catch(err){
    console.error(err);
    setStatus("Speichern fehlgeschlagen. Prüfe Supabase-Rechte (RLS/Policies).");
  }
});

function fitToLights(animate=true){
  if(!allLightPoints || allLightPoints.length === 0){
    map.setView([20,0], 2, { animate });
    return;
  }
  const bounds = L.latLngBounds(allLightPoints.map(p => [p.lat, p.lng]));
  map.fitBounds(bounds.pad(0.35), { animate, duration: 0.9 });
}

document.getElementById("btnWorld").addEventListener("click", () => fitToLights(true));

// "Karte generieren": zoomt kurz zur Weltansicht, exportiert PNG
document.getElementById("btnCard").addEventListener("click", () => {
  fitToLights(true);
  setTimeout(() => {
    leafletImage(map, function(err, canvas) {
      if (err) { alert("Export fehlgeschlagen."); return; }
      const png = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = png;
      a.download = "eine-menschheit-karte.png";
      a.click();
    });
  }, 950);
});

// Start
loadLights();
setInterval(loadLights, 30000);
</script>
</body>
</html>
