<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Together We Are One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- PNG Export helper -->
  <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Together We Are One">
  <meta property="og:description" content="A quiet place. You set a light and see that many feel the same.">
  <meta property="og:image" content="https://togetherweareone.earth/TogetherWeAreOneEarth.jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="1200">
  <meta property="og:url" content="https://togetherweareone.earth/">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://togetherweareone.earth/TogetherWeAreOneEarth.jpeg">

  <style>
:root{
  --bg0:#0b0d12;
  --bg1:#121526;
  --card: rgba(255,255,255,0.06);
  --card2: rgba(255,255,255,0.08);
  --stroke: rgba(255,255,255,0.10);
  --ghost: rgba(255,255,255,0.25);
  --text: rgba(255,255,255,0.92);
  --warm: rgba(255,220,170,0.95);
  --shade-opacity: 0.10;
  --map-brightness: 0.65;
  --map-contrast: 1.0;
  --map-saturate: 0.0;
}

.leaflet-tile{
  filter:
    grayscale(1)
    brightness(var(--map-brightness))
    contrast(var(--map-contrast))
    saturate(var(--map-saturate));
}

html{ margin:0; }
body{
  margin:0;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg0));
  font-family:system-ui,-apple-system,"Inter",sans-serif;
  min-height:100dvh;
  display:flex;
  flex-direction:column;
}

/* Layout */
.wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:20px 16px;
}
.content{
  flex:1;
  width:100%;
  max-width:1000px;
  margin:0 auto;

  display:grid;
  grid-template-rows:auto 1fr auto;
  gap:18px;

  min-height:0;
}

/* Cards */
.teleprompter{
  position:relative;
  padding:16px 20px;
  backdrop-filter:blur(20px);
  background:linear-gradient(
    180deg,
    rgba(255,255,255,0.05),
    rgba(255,255,255,0.02)
  );
  border-radius: 22px;
  overflow: hidden; 
}

.mapWrap{
  position:relative;
  overflow:hidden;
  background:#0a0b10;
  display:flex;
  min-height:320px;
  border-radius: 22px;
  overflow: hidden;
}

.teleprompter,
.mapWrap{
  border-radius: 26px;
  box-shadow: 
    0 20px 60px rgba(0,0,0,0.35),
    inset 0 1px 0 rgba(255,255,255,0.05);
}

.mapTint,
.mapShade{
  pointer-events:none;
  position:absolute;
  inset:0;
  z-index:2;
}

.mapTint{
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.05), rgba(0,0,0,0.35));
  mix-blend-mode:multiply;
}
.mapShade{
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.0), rgba(0,0,0,0.55));
}

/* Map */
#map{ flex:1; }

.status,
.hint,
.privacy-hint{
  font-size:13px;
  opacity:0.65;
  margin:4px 0;
}

.hint{
  position:sticky;
  bottom:10px;
}

.leaflet-container{
  background:#0a0b10 !important;
  cursor:crosshair;
}

/* Subtiles Nacht-Softening */
.mapDarkOverlay{
  pointer-events:none;
  position:absolute;
  inset:0;
  z-index:1;
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.05), rgba(0,0,0,0.15));
}

/* Center Control */
.mapCenterControl{
  position:absolute;
  top:25px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
}

.world-btn{
  padding:8px 18px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.28);
  color:white;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s ease;
}
.world-btn:hover{
  background:rgba(255,220,170,0.12);
  border:1px solid rgba(255,220,170,0.35);
}

/* Teleprompter */
.tp-text{
  text-align:center;
  font-size:clamp(16px, 2vw, 24px);
  line-height:1.35;
  min-height:1.8em;
}
.tp-word{ color:var(--ghost); transition:0.2s; }
.tp-word.done{ color:var(--warm); }
.tp-word.active{ color:white; }

.tp-meta{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  margin-top:6px;
}

.tp-btn{
  background:transparent;
  border:none;
  opacity:0.5;
  padding:6px 10px;
  color: inherit;
}
.tp-btn:hover{ opacity:1; }

.tp-progress{
  width:min(500px, 60vw);
  height:4px;
  border-radius:6px;
  overflow:hidden;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.08);
  flex:0 1 420px;
}

.tp-progress-bar{
  height:4px;
  width:0%;
  background: linear-gradient(90deg, rgba(255,220,170,0.7), rgba(255,255,255,0.6));
  transition: width 0.6s cubic-bezier(.4,0,.2,1);
}

.tp-actions{
  margin-top:14px;
  min-height:0;
  position:relative;
}
.tp-actions-center{ text-align:center; }
.tp-actions-right{
  position:absolute;
  right:0;
  top:0;
}

.share-btn{
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.12);
  padding:8px 18px;
  font-size:14px;
  border-radius:999px;
  font-weight:500;
  letter-spacing:0.02em;
}

.export-btn{
  background:rgba(255,220,170,0.15);
  border:1px solid rgba(255,220,170,0.35);
  position:absolute;
  bottom:14px;
  right:14px;
  padding:6px 10px;
  font-size:12px;
  border-radius:10px;
  opacity:0.6;
}

/* Footer text */
.status,
.hint,
.privacy-hint{
  text-align:center;
  margin-top:14px;
  font-size:14px;
  opacity:0.7;
}

/* Attribution */
.leaflet-control-attribution{
  background:rgba(0,0,0,0.35) !important;
  color:rgba(255,255,255,0.65);
}

/* Lang badge */
#langBadge{
  position:fixed;
  top:15px;
  left:15px;
  font-size:12px;
  opacity:0.6;
  z-index:2000;
}

.map-actions {
  position:absolute;
  left:16px;      /* ← statt right */
  bottom:16px;
  z-index:700;
  transition: opacity 200ms ease;
}

.map-actions button{
  padding:12px 22px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.12);
  color:white;
  font-weight:600;
  letter-spacing:0.02em;
  backdrop-filter: blur(10px);
  cursor:pointer;
  transition: all 160ms ease;
}

.map-actions button:hover{
  background: rgba(255,255,255,0.22);
  transform: translateY(-1px);
}
    
.map-actions.disabled {
  opacity: 0.4;
  pointer-events: none;
}
  
  </style>
</head>

<body>

<!-- FIX: existiert jetzt wirklich -->
<div id="langBadge"></div>

<div class="wrap">
  <div class="content">

    <!-- TELEPROMPTER -->
    <div class="teleprompter">
      <p id="tp-text" class="tp-text"></p>

      <div class="tp-meta">
        <button id="tp-prev" class="tp-btn" type="button">←</button>

        <div class="tp-progress">
          <div class="tp-progress-bar" id="tp-bar"></div>
        </div>

        <button id="tp-next" class="tp-btn" type="button">→</button>
      </div>

      <div class="tp-actions">
        <div class="tp-actions-center">
          <button id="shareMain" class="tp-btn share-btn" type="button"></button>
        </div>
      </div>
    </div>

    <!-- KARTE -->
    <div class="mapWrap">
     <div id="map"></div>
      <div class="map-actions">
        <button id="btnCard" type="button"></button>
      </div>

      <!-- FIX: overlay existiert jetzt -->
      <div class="mapDarkOverlay"></div>

      <div class="mapTint"></div>
      <div class="mapShade"></div>
    </div>

    <!-- Footer -->
    <p id="privacyHint" class="privacy-hint"></p>
    <p id="status" class="status"></p>
    <p id="hint" class="hint"></p>

  </div>
</div>

<script>
/* -------------------------
   1) Language Detection
-------------------------- */
function getLangFromUrl() {
  const p = new URLSearchParams(location.search);
  const v = (p.get("lang") || "").trim();
  return v ? v.toLowerCase() : null;
}
function normalizeLang(tag) {
  if (!tag) return "en";
  const t = tag.toLowerCase();
  if (t.startsWith("zh")) return "zh";
  if (t.startsWith("in")) return "id";
  if (t.startsWith("iw")) return "he";
  if (t.startsWith("pt")) return "pt";
  return t.split("-")[0];
}
const SUPPORTED = [
  "en","de","es","fr","pt","ru","ar","hi",
  "bn","ur","zh","ja","ko","vi","tr","sw","id"
];
function pickLanguage() {
  const urlLang = normalizeLang(getLangFromUrl());
  if (urlLang && SUPPORTED.includes(urlLang)) return urlLang;

  const prefs = (navigator.languages && navigator.languages.length)
    ? navigator.languages.map(normalizeLang)
    : [normalizeLang(navigator.language || "en")];

  for (const lang of prefs) {
    if (SUPPORTED.includes(lang)) return lang;
  }
  return "en";
}
const LANG = pickLanguage();
document.documentElement.lang = LANG;
const lb = document.getElementById("langBadge");
if (lb) lb.textContent = LANG.toUpperCase();

/* -------------------------
   2) Teleprompter Text
-------------------------- */
const TP = {
  en: [
    "We almost never think about it.",
    "Our lives on this small blue planet in space.",
    "In this brief blink long after the Big Bang.",
    "That it exists at all – as far as we know – is unique.",
    "That makes us all special. And it connects us.",
    "Here you can place a light. And see that many feel the same."
  ],
  de: [
    "Wir denken fast nie daran.",
    "Unser Leben auf dieser kleinen blauen Kugel im Weltall.",
    "In diesem Augenzwinkern lange nach dem Urknall.",
    "Dass es das überhaupt gibt – nach allem was wir wissen – ist einzigartig.",
    "Das macht uns alle besonders. Und es verbindet uns.",
    "Hier kannst du ein Licht setzen. Und sehen, dass viele dasselbe fühlen."
  ],
  es: [
    "Casi nunca pensamos en ello.",
    "Nuestra vida en esta pequeña esfera azul en el espacio.",
    "En este parpadeo fugaz mucho después del Big Bang.",
    "Que exista – según todo lo que sabemos – es único.",
    "Eso nos hace especiales a todos. Y nos conecta.",
    "Aquí puedes colocar una luz. Y ver que muchos sienten lo mismo."
  ],
  fr: [
    "Nous n’y pensons presque jamais.",
    "À notre vie sur cette petite planète bleue dans l’espace.",
    "Dans ce clin d’œil fugace longtemps après le Big Bang.",
    "Le fait que cela existe – selon ce que nous savons – est unique.",
    "Cela nous rend tous particuliers. Et nous relie.",
    "Ici, tu peux placer une lumière. Et voir que beaucoup ressentent la même chose."
  ],
  pt: [
    "Quase nunca pensamos nisso.",
    "Nossa vida neste pequeno planeta azul no espaço.",
    "Neste breve instante muito depois do Big Bang.",
    "Que ele exista – pelo que sabemos – é algo único.",
    "Isso nos torna especiais. E nos conecta.",
    "Aqui você pode colocar uma luz. E ver que muitos sentem o mesmo."
  ],
  ru: [
    "Мы почти никогда об этом не думаем.",
    "О нашей жизни на этой маленькой голубой планете.",
    "В этом кратком мгновении спустя долгое время после Большого взрыва.",
    "То, что она существует – насколько мы знаем – уникально.",
    "Это делает нас особенными. И соединяет нас.",
    "Здесь ты можешь зажечь свет. И увидеть, что многие чувствуют то же самое."
  ],
  ar: [
    "نادراً ما نفكر في ذلك.",
    "في حياتنا على هذا الكوكب الأزرق الصغير.",
    "في هذه اللحظة القصيرة بعد زمن طويل من الانفجار العظيم.",
    "أن وجوده – حسب ما نعرف – أمر فريد.",
    "هذا يجعلنا جميعاً مميزين. ويربطنا.",
    "هنا يمكنك أن تضع نوراً. وترى أن كثيرين يشعرون بالشيء نفسه."
  ],
  hi: [
    "हम लगभग कभी इसके बारे में नहीं सोचते।",
    "इस छोटे नीले ग्रह पर हमारे जीवन के बारे में।",
    "इस छोटे से क्षण में, महाविस्फोट के बहुत बाद।",
    "कि इसका अस्तित्व है – जितना हम जानते हैं – अद्वितीय है।",
    "यह हमें विशेष बनाता है। और जोड़ता है।",
    "यहाँ आप एक रोशनी रख सकते हैं। और देख सकते हैं कि कई लोग वही महसूस करते हैं।"
  ],
  bn: [
    "আমরা প্রায় কখনোই এটা নিয়ে ভাবি না।",
    "এই ছোট নীল গ্রহে আমাদের জীবন নিয়ে।",
    "এই ক্ষণিক মুহূর্তে, বিগ ব্যাংয়ের অনেক পরে।",
    "এর অস্তিত্ব – যতটুকু আমরা জানি – অনন্য।",
    "এটি আমাদের বিশেষ করে তোলে। এবং যুক্ত করে।",
    "এখানে তুমি একটি আলো বসাতে পারো। এবং দেখতে পারো যে অনেকেই একই অনুভব করে।"
  ],
  ur: [
    "ہم تقریباً کبھی اس کے بارے میں نہیں سوچتے۔",
    "اس چھوٹے نیلے سیارے پر اپنی زندگی کے بارے میں۔",
    "اس مختصر لمحے میں، بگ بینگ کے بہت بعد۔",
    "کہ اس کا وجود ہے – جتنا ہم جانتے ہیں – منفرد ہے۔",
    "یہ ہمیں خاص بناتا ہے۔ اور جوڑتا ہے۔",
    "یہاں آپ ایک روشنی رکھ سکتے ہیں۔ اور دیکھ سکتے ہیں کہ بہت سے لوگ یہی محسوس کرتے ہیں۔"
  ],
  zh: [
    "我们几乎从不去想这些。",
    "关于我们在这颗小小蓝色星球上的生活。",
    "在宇宙大爆炸之后漫长岁月中的这一瞬间。",
    "它的存在——据我们所知——是独一无二的。",
    "这让我们与众不同，也让我们彼此连接。",
    "在这里，你可以点亮一盏灯，看到许多人有着同样的感受。"
  ],
  ja: [
    "私たちはほとんど考えません。",
    "この小さな青い惑星での私たちの暮らしについて。",
    "ビッグバンから長い時間が過ぎたこの一瞬について。",
    "それが存在していること自体が、私たちの知る限り特別です。",
    "それは私たちを特別にし、つなげます。",
    "ここで光を置くことができます。そして多くの人が同じように感じていることが見えます。"
  ],
  ko: [
    "우리는 거의 생각하지 않습니다.",
    "이 작은 푸른 행성에서의 우리의 삶에 대해.",
    "빅뱅 이후 오랜 시간이 지난 이 짧은 순간에 대해.",
    "그 존재 자체가 우리가 아는 한 특별합니다.",
    "그것은 우리를 특별하게 만들고 연결합니다.",
    "여기에서 빛을 놓을 수 있습니다. 그리고 많은 이들이 같은 감정을 느끼고 있음을 볼 수 있습니다."
  ],
  vi: [
    "Chúng ta hầu như không bao giờ nghĩ đến điều đó.",
    "Về cuộc sống của mình trên hành tinh xanh nhỏ bé này.",
    "Trong khoảnh khắc ngắn ngủi rất lâu sau Vụ Nổ Lớn.",
    "Việc nó tồn tại – theo những gì chúng ta biết – là điều độc nhất.",
    "Điều đó khiến chúng ta trở nên đặc biệt. Và kết nối chúng ta.",
    "Tại đây, bạn có thể đặt một ánh sáng và thấy rằng nhiều người cũng cảm nhận như vậy."
  ],
  tr: [
    "Bunu neredeyse hiç düşünmeyiz.",
    "Bu küçük mavi gezegendeki hayatımızı.",
    "Büyük Patlama’dan çok sonra bu kısa an içinde.",
    "Onun var olması – bildiğimiz kadarıyla – benzersizdir.",
    "Bu bizi özel kılar. Ve birbirimize bağlar.",
    "Burada bir ışık bırakabilirsin ve birçok kişinin aynı şeyi hissettiğini görebilirsin."
  ],
  sw: [
    "Karibu hatufikirii kuhusu hilo.",
    "Kuhusu maisha yetu kwenye sayari hii ndogo ya buluu.",
    "Katika mng’ao huu mfupi muda mrefu baada ya Mlipo Mkuu.",
    "Kwamba yapo – kadiri tunavyojua – ni ya kipekee.",
    "Hilo hutufanya tuwe wa pekee na hutunganisha.",
    "Hapa unaweza kuweka mwanga na kuona kwamba wengi wanahisi vivyo hivyo."
  ],
  id: [
    "Kita hampir tidak pernah memikirkannya.",
    "Tentang kehidupan kita di planet biru kecil ini.",
    "Dalam kedipan singkat ini lama setelah Dentuman Besar.",
    "Bahwa itu ada – sejauh yang kita ketahui – adalah sesuatu yang unik.",
    "Hal itu membuat kita istimewa dan menghubungkan kita.",
    "Di sini kamu bisa menempatkan sebuah cahaya dan melihat bahwa banyak yang merasakan hal yang sama."
  ]
};

/* -------------------------
   3) UI Text
-------------------------- */
const UI = {

  en: {
    world: "World view",
    card: "Take a picture",
    hint: "Click on the map to place or move your light. (One light per browser.)",
    privacy: "Lights are anonymous and gently rounded to about 10 km.",
    status_empty: "Place your light on the map.",
    status_set: "Your light is glowing. You can move it anytime.",
    status_export: "Capturing the moment…",
    status_done: "Image saved.",
    status_error_load: "Unable to load lights.",
    status_error_save: "Unable to save image."
  },

  de: {
    world: "Weltansicht",
    card: "Moment festhalten",
    hint: "Klicke auf die Karte, um dein Licht zu setzen oder zu verschieben. (Ein Licht pro Browser.)",
    privacy: "Lichter sind anonym und sanft auf etwa 10 km gerundet.",
    status_empty: "Setze dein Licht auf der Karte.",
    status_set: "Dein Licht leuchtet. Du kannst es jederzeit verschieben.",
    status_export: "Moment wird festgehalten…",
    status_done: "Bild gespeichert.",
    status_error_load: "Lichter konnten nicht geladen werden.",
    status_error_save: "Bild konnte nicht gespeichert werden."
  },

  es: {
    world: "Vista mundial",
    card: "Capturar momento",
    hint: "Haz clic en el mapa para colocar o mover tu luz. (Una luz por navegador.)",
    privacy: "Las luces son anónimas y suavemente redondeadas a unos 10 km.",
    status_empty: "Coloca tu luz en el mapa.",
    status_set: "Tu luz está brillando. Puedes moverla cuando quieras.",
    status_export: "Capturando el momento…",
    status_done: "Imagen guardada.",
    status_error_load: "No se pudieron cargar las luces.",
    status_error_save: "No se pudo guardar la imagen."
  },

  fr: {
    world: "Vue du monde",
    card: "Capturer l’instant",
    hint: "Cliquez sur la carte pour placer ou déplacer votre lumière. (Une lumière par navigateur.)",
    privacy: "Les lumières sont anonymes et doucement arrondies à environ 10 km.",
    status_empty: "Placez votre lumière sur la carte.",
    status_set: "Votre lumière brille. Vous pouvez la déplacer à tout moment.",
    status_export: "Capture de l’instant…",
    status_done: "Image enregistrée.",
    status_error_load: "Impossible de charger les lumières.",
    status_error_save: "Impossible d’enregistrer l’image."
  },

  pt: {
    world: "Visão mundial",
    card: "Capturar momento",
    hint: "Clique no mapa para colocar ou mover sua luz. (Uma luz por navegador.)",
    privacy: "As luzes são anônimas e suavemente arredondadas para cerca de 10 km.",
    status_empty: "Coloque sua luz no mapa.",
    status_set: "Sua luz está brilhando. Você pode movê-la a qualquer momento.",
    status_export: "Capturando o momento…",
    status_done: "Imagem salva.",
    status_error_load: "Não foi possível carregar as luzes.",
    status_error_save: "Não foi possível salvar a imagem."
  },

  ru: {
    world: "Вид мира",
    card: "Сохранить момент",
    hint: "Нажмите на карту, чтобы разместить или переместить свет. (Один свет на браузер.)",
    privacy: "Огни анонимны и мягко округлены примерно до 10 км.",
    status_empty: "Разместите свой свет на карте.",
    status_set: "Ваш свет сияет. Вы можете переместить его в любой момент.",
    status_export: "Сохранение момента…",
    status_done: "Изображение сохранено.",
    status_error_load: "Не удалось загрузить огни.",
    status_error_save: "Не удалось сохранить изображение."
  },

  ar: {
    world: "عرض العالم",
    card: "احفظ اللحظة",
    hint: "انقر على الخريطة لوضع الضوء أو تحريكه. (ضوء واحد لكل متصفح.)",
    privacy: "الأضواء مجهولة الهوية ومقربة بلطف إلى حوالي 10 كم.",
    status_empty: "ضع نورك على الخريطة.",
    status_set: "نورك يضيء الآن. يمكنك تحريكه في أي وقت.",
    status_export: "جارٍ حفظ اللحظة…",
    status_done: "تم حفظ الصورة.",
    status_error_load: "تعذر تحميل الأضواء.",
    status_error_save: "تعذر حفظ الصورة."
  },

  hi: {
    world: "विश्व दृश्य",
    card: "क्षण सहेजें",
    hint: "मानचित्र पर क्लिक करके अपनी रोशनी रखें या बदलें। (प्रति ब्राउज़र एक रोशनी.)",
    privacy: "लाइट्स गुमनाम हैं और लगभग 10 किमी तक हल्के रूप में गोल की गई हैं।",
    status_empty: "मानचित्र पर अपनी रोशनी रखें।",
    status_set: "आपकी रोशनी चमक रही है। आप इसे कभी भी बदल सकते हैं।",
    status_export: "क्षण सहेजा जा रहा है…",
    status_done: "चित्र सहेजा गया।",
    status_error_load: "रोशनियाँ लोड नहीं हो सकीं।",
    status_error_save: "चित्र सहेजा नहीं जा सका।"
  },

  bn: {
    world: "বিশ্ব দৃশ্য",
    card: "মুহূর্ত সংরক্ষণ করুন",
    hint: "মানচিত্রে ক্লিক করে আপনার আলো বসান বা সরান। (প্রতি ব্রাউজারে একটি আলো.)",
    privacy: "আলো গুলো গোপনীয় এবং প্রায় ১০ কিমি পর্যন্ত হালকা ভাবে রাউন্ড করা হয়েছে।",
    status_empty: "মানচিত্রে আপনার আলো বসান।",
    status_set: "আপনার আলো জ্বলছে। আপনি যেকোনো সময় সরাতে পারেন।",
    status_export: "মুহূর্ত সংরক্ষণ করা হচ্ছে…",
    status_done: "ছবি সংরক্ষিত হয়েছে।",
    status_error_load: "আলো লোড করা যায়নি।",
    status_error_save: "ছবি সংরক্ষণ করা যায়নি।"
  },

  ur: {
    world: "عالمی منظر",
    card: "لمحہ محفوظ کریں",
    hint: "نقشے پر کلک کر کے اپنی روشنی رکھیں یا منتقل کریں۔ (ہر براؤزر کے لیے ایک روشنی.)",
    privacy: "روشنی گمنام ہے اور تقریباً 10 کلومیٹر تک نرمی سے گول کی گئی ہے۔",
    status_empty: "نقشے پر اپنی روشنی رکھیں۔",
    status_set: "آپ کی روشنی چمک رہی ہے۔ آپ اسے کسی بھی وقت منتقل کر سکتے ہیں۔",
    status_export: "لمحہ محفوظ کیا جا رہا ہے…",
    status_done: "تصویر محفوظ ہو گئی۔",
    status_error_load: "روشنی لوڈ نہیں ہو سکی۔",
    status_error_save: "تصویر محفوظ نہ ہو سکی۔"
  },

  zh: {
    world: "世界视图",
    card: "保存这一刻",
    hint: "点击地图以放置或移动你的光点。（每个浏览器一个光点。）",
    privacy: "灯光是匿名的，并柔和地四舍五入到约10公里。",
    status_empty: "在地图上放置你的光点。",
    status_set: "你的光点正在闪耀。你可以随时移动它。",
    status_export: "正在保存这一刻…",
    status_done: "图片已保存。",
    status_error_load: "无法加载光点。",
    status_error_save: "无法保存图片。"
  },

  ja: {
    world: "世界表示",
    card: "この瞬間を保存",
    hint: "地図をクリックして光を置いたり動かしたりしてください。（ブラウザごとに1つ）",
    privacy: "ライトは匿名で、約10km単位にやわらかく丸められています。",
    status_empty: "地図に光を置いてください。",
    status_set: "あなたの光が輝いています。いつでも動かせます。",
    status_export: "この瞬間を保存中…",
    status_done: "画像を保存しました。",
    status_error_load: "光を読み込めませんでした。",
    status_error_save: "画像を保存できませんでした。"
  },

  ko: {
    world: "세계 보기",
    card: "이 순간 저장",
    hint: "지도를 클릭하여 빛을 놓거나 이동하세요. (브라우저당 1개)",
    privacy: "빛은 익명이며 약 10km 단위로 부드럽게 반올림됩니다.",
    status_empty: "지도에 빛을 놓으세요.",
    status_set: "빛이 빛나고 있습니다. 언제든 이동할 수 있습니다.",
    status_export: "이 순간을 저장 중…",
    status_done: "이미지가 저장되었습니다.",
    status_error_load: "빛을 불러오지 못했습니다.",
    status_error_save: "이미지를 저장할 수 없습니다."
  },

  vi: {
    world: "Chế độ xem thế giới",
    card: "Lưu khoảnh khắc",
    hint: "Nhấp vào bản đồ để đặt hoặc di chuyển ánh sáng. (Một ánh sáng mỗi trình duyệt.)",
    privacy: "Các ánh sáng là ẩn danh và được làm tròn nhẹ nhàng khoảng 10 km.",
    status_empty: "Đặt ánh sáng của bạn trên bản đồ.",
    status_set: "Ánh sáng của bạn đang tỏa sáng. Bạn có thể di chuyển nó bất cứ lúc nào.",
    status_export: "Đang lưu khoảnh khắc…",
    status_done: "Hình ảnh đã được lưu.",
    status_error_load: "Không thể tải ánh sáng.",
    status_error_save: "Không thể lưu hình ảnh."
  },

  tr: {
    world: "Dünya görünümü",
    card: "Anı kaydet",
    hint: "Işığınızı yerleştirmek veya taşımak için haritaya tıklayın. (Tarayıcı başına bir ışık.)",
    privacy: "Işıklar anonimdir ve yaklaşık 10 km’ye yumuşak şekilde yuvarlanır.",
    status_empty: "Haritaya ışığınızı yerleştirin.",
    status_set: "Işığınız parlıyor. İstediğiniz zaman taşıyabilirsiniz.",
    status_export: "An kaydediliyor…",
    status_done: "Görsel kaydedildi.",
    status_error_load: "Işıklar yüklenemedi.",
    status_error_save: "Görsel kaydedilemedi."
  },

  sw: {
    world: "Mtazamo wa dunia",
    card: "Hifadhi wakati huu",
    hint: "Bofya ramani ili kuweka au kusogeza mwanga wako. (Mwanga mmoja kwa kivinjari.)",
    privacy: "Taa ni za siri na zimezungushwa kwa upole hadi takriban km 10.",
    status_empty: "Weka mwanga wako kwenye ramani.",
    status_set: "Mwanga wako unang'aa. Unaweza kuusogeza wakati wowote.",
    status_export: "Inahifadhi wakati huu…",
    status_done: "Picha imehifadhiwa.",
    status_error_load: "Imeshindikana kupakia taa.",
    status_error_save: "Imeshindikana kuhifadhi picha."
  },

  id: {
    world: "Tampilan dunia",
    card: "Simpan momen",
    hint: "Klik peta untuk menempatkan atau memindahkan cahaya Anda. (Satu cahaya per browser.)",
    privacy: "Cahaya bersifat anonim dan dibulatkan secara lembut hingga sekitar 10 km.",
    status_empty: "Tempatkan cahaya Anda di peta.",
    status_set: "Cahaya Anda sedang bersinar. Anda bisa memindahkannya kapan saja.",
    status_export: "Menyimpan momen…",
    status_done: "Gambar disimpan.",
    status_error_load: "Tidak dapat memuat cahaya.",
    status_error_save: "Tidak dapat menyimpan gambar."
  }

};

const UI_TEXT = UI[LANG] || UI.en;
const tpTexts = TP[LANG] || TP.en;

document.getElementById("btnCard").textContent  = UI_TEXT.card;
document.getElementById("hint").textContent     = UI_TEXT.hint;
document.getElementById("privacyHint").textContent = UI_TEXT.privacy;

/* -------------------------
   4) Teleprompter
-------------------------- */
const CHAR_BASED_LANGS = ["zh","ja","ko"];
const WORD_MS = (CHAR_BASED_LANGS.includes(LANG) ? 190 : 240);
const SENTENCE_PAUSE = 900;

let tpIndex = 0;
let tpUnitIdx = 0;
let tpTimer = null;

const tpTextEl = document.getElementById("tp-text");
const tpBarEl  = document.getElementById("tp-bar");

function updateProgress(){
  if(!tpBarEl) return;
  tpBarEl.style.width = `${100 * (tpIndex + 1) / tpTexts.length}%`;
}

function renderSentence(sentence){
  const s = (sentence || "").replace(/\n/g, " \n ");
  const tokens = s.split(/(\s+)/);

  tpTextEl.innerHTML = tokens.map(t => {
    if (t === "\n") return `<span class="tp-br"></span>`;
    if (/^\s+$/.test(t)) return `<span class="tp-space">${t}</span>`;
    return `<span class="tp-word">${t}</span>`;
  }).join("");
}

function getUnits(sentence){
  const s = sentence || "";
  if (CHAR_BASED_LANGS.includes(LANG)) {
    return Array.from(s.replace(/\s+/g, ""));
  }
  return s.replace(/\n/g, " ").split(/\s+/).filter(Boolean);
}

function markProgress(activeIdx){
  const wordSpans = Array.from(tpTextEl.querySelectorAll(".tp-word"));
  wordSpans.forEach((w, i) => {
    w.classList.remove("active");
    if (i <= activeIdx) w.classList.add("done");
    else w.classList.remove("done");
  });
  if (wordSpans[activeIdx]) wordSpans[activeIdx].classList.add("active");
}

function playSentence(idx, auto=true){
  clearInterval(tpTimer);
  tpIndex = idx;
  tpUnitIdx = 0;

  renderSentence(tpTexts[tpIndex]);
  updateProgress();
  const units = getUnits(tpTexts[tpIndex]);
  markProgress(0);

  tpTimer = setInterval(() => {
    tpUnitIdx++;
    if (tpUnitIdx < units.length) {
      markProgress(tpUnitIdx);
    } else {
      clearInterval(tpTimer);
      markProgress(Math.max(0, units.length - 1));
      if (auto) {
        setTimeout(() => {
          if (tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, true);
        }, SENTENCE_PAUSE);
      }
    }
  }, WORD_MS);
}

document.getElementById("tp-prev").addEventListener("click", () => {
  if (tpIndex > 0) playSentence(tpIndex - 1, false);
});
document.getElementById("tp-next").addEventListener("click", () => {
  if (tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, false);
});
playSentence(0, true);

/* -------------------------
   5) Share
-------------------------- */
const SHARE_MAIN_LABEL = {
  de: "Mit einer Freundin oder einem Freund teilen",
  en: "Share with a friend",
  fr: "Partager avec un ami",
  es: "Compartir con un amigo",
  pt: "Compartilhar com um amigo",
  ru: "Поделиться с другом",
  ar: "شارك مع صديق",
  hi: "किसी दोस्त के साथ साझा करें",
  bn: "একজন বন্ধুর সাথে শেয়ার করুন",
  ur: "کسی دوست کے ساتھ شیئر کریں",
  zh: "分享给朋友",
  ja: "友だちと共有する",
  ko: "친구와 공유하기",
  vi: "Chia sẻ với một người bạn",
  tr: "Bir arkadaşınla paylaş",
  sw: "Shiriki na rafiki",
  id: "Bagikan dengan seorang teman"
};

const SHARE_TEXT = {
  de: "Eine stille Seite. Man setzt ein Licht und sieht, dass viele dasselbe fühlen.",
  en: "A quiet place. You set a light and see that many feel the same.",
  es: "Un lugar tranquilo. Pones una luz y ves que muchos sienten lo mismo.",
  fr: "Un endroit calme. On y place une lumière et on voit que beaucoup ressentent la même chose.",
  pt: "Um lugar tranquilo. Você coloca uma luz e vê que muitos sentem o mesmo.",
  ru: "Тихое место. Ты зажигаешь свет и видишь, что многие чувствуют то же самое.",
  ar: "مكان هادئ. تضع نورًا وترى أن كثيرين يشعرون بالشيء نفسه.",
  hi: "एक शांत जगह। आप एक रोशनी रखते हैं और देखते हैं कि बहुत से लोग वही महसूस करते हैं।",
  bn: "একটি শান্ত জায়গা। তুমি একটি আলো বসাও এবং দেখো যে অনেকেই একই অনুভব করে।",
  ur: "ایک خاموش جگہ۔ آپ ایک روشنی رکھتے ہیں اور دیکھتے ہیں کہ بہت سے لوگ وہی محسوس کرتے ہیں۔",
  zh: "一个安静的地方。你点亮一盏灯，看到许多人有着相同的感受。",
  ja: "静かな場所。光を置くと、同じように感じている人がたくさんいることがわかります。",
  ko: "조용한 공간. 빛을 놓으면 많은 사람들이 같은 감정을 느끼고 있음을 볼 수 있습니다.",
  vi: "Một nơi yên tĩnh. Bạn đặt một ánh sáng và thấy rằng nhiều người cũng cảm nhận như vậy.",
  tr: "Sessiz bir yer. Bir ışık bırakırsın ve birçok kişinin aynı şeyi hissettiğini görürsün.",
  sw: "Mahali tulivu. Unaweka mwanga na kuona kwamba wengi wanahisi vivyo hivyo.",
  id: "Tempat yang tenang. Kamu menempatkan sebuah cahaya dan melihat bahwa banyak yang merasakan hal yang sama."
};

function shareUrlForLang() {
  return `${location.origin}/?lang=${encodeURIComponent(LANG)}`;
}

function createShareOverlay(url, text) {

  const overlay = document.createElement("div");
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(0,0,0,0.55)";
  overlay.style.backdropFilter = "blur(8px)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.zIndex = "5000";
  overlay.style.animation = "fadeIn 0.2s ease";

  const box = document.createElement("div");
  box.style.background = "rgba(20,20,25,0.96)";
  box.style.padding = "28px";
  box.style.borderRadius = "26px";
  box.style.display = "flex";
  box.style.flexDirection = "column";
  box.style.gap = "14px";
  box.style.minWidth = "260px";
  box.style.boxShadow = "0 30px 80px rgba(0,0,0,0.6)";

  function makeBtn(label, href) {
    const a = document.createElement("a");
    a.href = href;
    a.target = "_blank";
    a.rel = "noopener";
    a.textContent = label;
    a.style.padding = "11px 18px";
    a.style.borderRadius = "999px";
    a.style.textAlign = "center";
    a.style.background = "rgba(255,255,255,0.08)";
    a.style.color = "white";
    a.style.textDecoration = "none";
    a.style.fontWeight = "500";
    a.style.transition = "all 0.15s ease";
    a.onmouseenter = () => {
      a.style.background = "rgba(255,255,255,0.18)";
      a.style.transform = "translateY(-1px)";
    };
    a.onmouseleave = () => {
      a.style.background = "rgba(255,255,255,0.08)";
      a.style.transform = "translateY(0)";
    };
    return a;
  }

  const encodedFull = encodeURIComponent(text + " " + url);
  const encodedUrl  = encodeURIComponent(url);

  box.appendChild(makeBtn("WhatsApp", `https://wa.me/?text=${encodedFull}`));
  box.appendChild(makeBtn("Telegram", `https://t.me/share/url?url=${encodedUrl}&text=${encodeURIComponent(text)}`));
  box.appendChild(makeBtn("Signal", `https://signal.me/#p/${encodedFull}`));
  box.appendChild(makeBtn("Facebook", `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`));
  box.appendChild(makeBtn("Email", `mailto:?subject=Together We Are One&body=${encodedFull}`));

  const copyBtn = document.createElement("button");
  copyBtn.textContent = "Copy link";
  copyBtn.style.padding = "11px 18px";
  copyBtn.style.borderRadius = "999px";
  copyBtn.style.border = "1px solid rgba(255,255,255,0.15)";
  copyBtn.style.background = "rgba(255,255,255,0.08)";
  copyBtn.style.color = "white";
  copyBtn.style.cursor = "pointer";
  copyBtn.style.transition = "0.15s";

  copyBtn.onclick = async () => {
    await navigator.clipboard.writeText(url);
    copyBtn.textContent = "Copied";
    setTimeout(() => overlay.remove(), 900);
  };

  box.appendChild(copyBtn);
  overlay.appendChild(box);

  overlay.onclick = (e) => {
    if (e.target === overlay) overlay.remove();
  };

  document.body.appendChild(overlay);
}

function initShareButton() {

  const btn = document.getElementById("shareMain");
  if (!btn) return;

  btn.textContent = SHARE_MAIN_LABEL[LANG] || SHARE_MAIN_LABEL.en;

  btn.onclick = async function () {

    const url   = shareUrlForLang();
    const text  = SHARE_TEXT[LANG] || SHARE_TEXT.en;
    const title = "Together We Are One";

    // Mobile → Native Share
    if (navigator.share) {
      try {
        await navigator.share({ title, text, url });
        return;
      } catch (err) {
        if (err?.name === "AbortError") return;
      }
    }

    // Desktop → Modern overlay
    createShareOverlay(url, text);
  };
}

initShareButton();
/* -------------------------
   6) Supabase + Status
-------------------------- */
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

const SUPABASE_URL = 'https://gwfqdukbcgtcefqtgnbl.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3ZnFkdWtiY2d0Y2VmcXRnbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDU2MTMsImV4cCI6MjA4NDI4MTYxM30.ePyuDxhVoc1ol5lQ8JbRKaybgpEPozBR3Wf71oFj040';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let session = localStorage.getItem('myLightSession');
if(!session){
  session = uuidv4();
  localStorage.setItem('myLightSession', session);
}

const statusEl = document.getElementById("status");
function setStatus(key){
  const v = UI_TEXT[key] || key || "";
  if (statusEl) statusEl.textContent = v;
}

/* -------------------------
   7) Map
-------------------------- */
const WORLD_BOUNDS = L.latLngBounds(L.latLng(-60, -180), L.latLng(85, 180));
const WORLD_VIEW = { center: [20, 0], zoom: 2.0 };

function afterTwoFrames(fn){ requestAnimationFrame(() => requestAnimationFrame(fn)); }

const map = L.map('map', {
  zoomControl: true,
  preferCanvas: true,
  worldCopyJump: false,
  zoomSnap: 0.25,
  zoomDelta: 0.25,
  maxBounds: WORLD_BOUNDS,
  maxBoundsViscosity: 1.0
});

const canvasRenderer = L.canvas({ padding: 0.5 });
const lightsLayer = L.layerGroup().addTo(map);

function addLight(latlng, isMine=false){
  L.circleMarker(latlng, {
    renderer: canvasRenderer,
    radius: isMine ? 2.6 : 1.35,
    stroke: false,
    fill: true,
    fillOpacity: isMine ? 0.95 : 0.70,
    fillColor: "rgba(255,250,245,1)",
    interactive: isMine
  }).addTo(lightsLayer);
}

map.setView(WORLD_VIEW.center, WORLD_VIEW.zoom, { animate: false });
function goWorld(){ map.setView(WORLD_VIEW.center, WORLD_VIEW.zoom, { animate: false }); }

map.whenReady(() => {
  afterTwoFrames(() => {
    map.invalidateSize(true);
    goWorld();
  });
});
window.addEventListener("pageshow", () => {
  afterTwoFrames(() => {
    map.invalidateSize(true);
    goWorld();
  });
});

let _resizeT = null;
window.addEventListener("resize", () => {
  clearTimeout(_resizeT);
  _resizeT = setTimeout(() => map.invalidateSize(true), 150);
});

const voyagerTiles = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 18, noWrap: true, bounds: WORLD_BOUNDS, crossOrigin: true }
).addTo(map);

const exportTiles = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 18, noWrap: true, bounds: WORLD_BOUNDS, crossOrigin: true }
);

let myExactLatLng = null;

function anonymize(lat, lng) {
  const GRID = 0.1;
  return { lat: Math.round(lat / GRID) * GRID, lng: Math.round(lng / GRID) * GRID };
}

const ghost = L.circleMarker([0,0], { radius: 10, stroke: false, fill: true, fillOpacity: 0.0, fillColor: "rgba(255,220,170,1)", interactive: false }).addTo(map);
const ghostCore = L.circleMarker([0,0], { radius: 2.2, stroke: false, fill: true, fillOpacity: 0.0, fillColor: "rgba(255,250,245,1)", interactive: false }).addTo(map);

map.on("mouseover", () => { ghost.setStyle({ fillOpacity: 0.10 }); ghostCore.setStyle({ fillOpacity: 0.75 }); });
map.on("mouseout",  () => { ghost.setStyle({ fillOpacity: 0.0  }); ghostCore.setStyle({ fillOpacity: 0.0  }); });
map.on("mousemove", (e) => { ghost.setLatLng(e.latlng); ghostCore.setLatLng(e.latlng); });

async function loadMyLight(){
  const { data } = await sb.from('lights').select('*').eq('session', session).maybeSingle();
  return data;
}

let allLightPoints = [];

async function loadLights(){
  try{
    const { data, error } = await sb.from('lights').select('*');
    if(error) throw error;

    lightsLayer.clearLayers();

    let mine = null;
    for(const row of (data || [])){
      const isMine = (row.session === session);
      if(isMine) mine = row;

      if (isMine && myExactLatLng) addLight([myExactLatLng.lat, myExactLatLng.lng], true);
      else addLight([row.lat, row.lng], isMine);
    }

    allLightPoints = data || [];

    const hintEl = document.getElementById("hint");
    if (mine) {
      if (hintEl) hintEl.style.display = "none";
      setStatus("status_set");
    } else {
      if (hintEl) hintEl.style.display = "block";
      setStatus("status_empty");
     const actions = document.querySelector(".map-actions");

if (mine) {
  if (hintEl) hintEl.style.display = "none";
  setStatus("status_set");
  if (actions) actions.style.opacity = "1";
} else {
  if (hintEl) hintEl.style.display = "block";
  setStatus("status_empty");
  if (actions) actions.style.opacity = "0.5";
}
    }

  }catch(e){
    console.error(e);
    setStatus("status_error_load");
  }
}

map.on('click', async (e) => {
  try {
    const clickedLatLng = e.latlng;
    const anonymized = anonymize(clickedLatLng.lat, clickedLatLng.lng);
    myExactLatLng = clickedLatLng;

    const existing = await loadMyLight();

    if(existing){
      await sb.from('lights').update({ lat: anonymized.lat, lng: anonymized.lng }).eq('session', session);
    } else {
      await sb.from('lights').insert({ lat: anonymized.lat, lng: anonymized.lng, session });
    }

    await loadLights();
  } catch(err){
    console.error(err);
  }
});

/* -------------------------
   8) Export
-------------------------- */
function waitMoveEnd(m) {
  return new Promise(resolve => {
    let done = false;
    const finish = () => {
      if(done) return;
      done = true;
      m.off("moveend", finish);
      resolve();
    };
    m.once("moveend", finish);
    setTimeout(finish, 450);
  });
}

function waitTiles(layer){
  return new Promise(resolve => {
    let done = false;
    const finish = () => {
      if(done) return;
      done = true;
      layer.off("load", finish);
      requestAnimationFrame(() => requestAnimationFrame(resolve));
    };
    layer.once("load", finish);
    setTimeout(finish, 1800);
  });
}

document.getElementById("btnCard").addEventListener("click", async () => {
  try {
    setStatus("status_export");

    goWorld();
    await waitMoveEnd(map);

    if (map.hasLayer(voyagerTiles)) map.removeLayer(voyagerTiles);
    exportTiles.addTo(map);
    await waitTiles(exportTiles);

    map.removeLayer(lightsLayer);

    const exportLayer = L.layerGroup();
    for (const row of allLightPoints) {
      const isMine = row.session === session;
      L.circleMarker([row.lat, row.lng], {
        radius: isMine ? 2.6 : 1.35,
        stroke: false,
        fill: true,
        fillOpacity: isMine ? 0.95 : 0.70,
        fillColor: "rgba(255,250,245,1)"
      }).addTo(exportLayer);
    }
    exportLayer.addTo(map);

    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    const tiles = document.querySelectorAll(".leaflet-tile");
    tiles.forEach(t => t.style.filter = "none");

    const overlay = document.querySelector(".mapDarkOverlay");
    if (overlay) overlay.style.display = "none";

    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    leafletImage(map, function(err, canvas){
      tiles.forEach(t => t.style.filter = "");
      if (overlay) overlay.style.display = "";

      map.removeLayer(exportLayer);
      lightsLayer.addTo(map);
      map.removeLayer(exportTiles);
      voyagerTiles.addTo(map);

      if(err){
        console.error(err);
        setStatus("status_error_save");
        return;
      }

      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "together-we-are-one.png";
      link.click();

      setStatus("status_done");
    });

  } catch(e){
    console.error(e);
    setStatus("status_error_save");
  }
});

/* -------------------------
   9) Start
-------------------------- */
loadLights();
setInterval(loadLights, 30000);
</script>
</body>
</html>
