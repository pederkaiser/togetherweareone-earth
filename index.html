<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eine Menschheit</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Export als PNG -->
  <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>

  <style>
    :root{
      --bg:#0b0d12;
      --ghost: rgba(255,255,255,0.18);
      --hi: rgba(255,255,255,0.95);
      --warm: rgba(255,220,170,0.95);
    }
    html, body { height: 100%; margin: 0; }
    body{
      background: radial-gradient(1200px 700px at 50% 15%, #1a2033 0%, var(--bg) 60%, #07080c 100%);
      color: #fff;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Inter", "Segoe UI", Arial, sans-serif;
    }

    .wrap{
      min-height: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 18px;
      padding: 22px;
      box-sizing: border-box;
    }

    /* Zentrierter Textblock */
    .copy{
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .line{
      max-width: 980px;
      text-align: center;
      font-size: clamp(20px, 3vw, 34px);
      line-height: 1.45;
      letter-spacing: 0.2px;
      margin: 0;
      font-weight: 500;
    }
    .word{
      color: var(--ghost);
      transition: color 160ms ease, filter 160ms ease;
      white-space: pre; /* Leerzeichen behalten */
    }
    .word.active{
      color: var(--hi);
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.14));
    }
    .word.active.warm{
      color: var(--warm);
      filter: drop-shadow(0 0 14px rgba(255,210,140,0.20));
    }

    /* Karte */
    #map{
      height: min(58vh, 560px);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 50px rgba(0,0,0,0.35);
      background: #000;
    }
    /* Noch dunklerer Gesamteindruck ohne Style-Basteln */
    .leaflet-tile {
      filter: brightness(0.72) contrast(1.15) saturate(0.85);
    }

    /* Buttons */
    .controls{
      display:flex;
      justify-content:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    button{
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.2px;
      backdrop-filter: blur(8px);
    }
    button:hover{
      background: rgba(255,255,255,0.12);
    }

    .hint{
      text-align:center;
      color: rgba(255,255,255,0.55);
      font-size: 13px;
      margin: 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="copy">
      <p id="line" class="line"></p>
    </div>

    <div id="map" aria-label="Weltkarte"></div>

    <div class="controls">
      <button id="btnWorld">Weltansicht</button>
      <button id="btnExport">Karte generieren (PNG)</button>
      <button id="btnClear">Lichter löschen</button>
    </div>

    <p class="hint">Tipp: Zoome hinein, tippe auf einen Ort – dort erscheint ein Licht.</p>
  </div>

  <script>
    /***** 1) Ghost-Text + Wort-für-Wort Highlight *****/
    const text = `Manchmal schauen wir in den Himmel. Vielleicht sehen wir einen Stern, den Mond, ferne Galaxien.
Für einen Moment wird uns bewusst, wie klein unser Planet ist. Wie selten – vielleicht sogar einzigartig – das Leben hier ist.`;

    const lineEl = document.getElementById("line");
    const tokens = text.split(/(\s+)/); // Worte + Leerzeichen behalten

    lineEl.innerHTML = tokens.map(t => {
      if (/^\s+$/.test(t)) return `<span class="word space">${t}</span>`;
      return `<span class="word">${t}</span>`;
    }).join("");

    const wordSpans = Array.from(lineEl.querySelectorAll(".word"))
      .filter(s => !s.classList.contains("space"));

    let wi = 0;
    function highlightStep(){
      wordSpans.forEach(s => s.classList.remove("active","warm"));
      if (wordSpans[wi]) wordSpans[wi].classList.add("active","warm");
      wi = (wi + 1) % wordSpans.length;
    }
    highlightStep();
    setInterval(highlightStep, 260);

    /***** 2) Leaflet Map: dunkler Basemap + Lichter *****/
    const map = L.map("map", {
      worldCopyJump: true,
      zoomControl: true,
      preferCanvas: true
    }).setView([20, 10], 2);

    // Dunkle, sehr verbreitete Tiles:
    // CARTO Dark Matter (tokenfrei), Attribution beachten
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      subdomains: "abcd",
      maxZoom: 19,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);

    // Layergruppe für Lichter
    const lightsLayer = L.layerGroup().addTo(map);

    // Canvas Renderer für viele Punkte (Performance)
    const canvasRenderer = L.canvas({ padding: 0.5 });

    function addLight(latlng){
      // 1) Glow (größer, weich)
      L.circleMarker(latlng, {
        renderer: canvasRenderer,
        radius: 10,
        stroke: false,
        fill: true,
        fillOpacity: 0.20,
        fillColor: "rgba(255,220,170,1)"
      }).addTo(lightsLayer);

      // 2) Kern (klein, hell)
      L.circleMarker(latlng, {
        renderer: canvasRenderer,
        radius: 3.2,
        stroke: false,
        fill: true,
        fillOpacity: 0.95,
        fillColor: "rgba(255,245,235,1)"
      }).addTo(lightsLayer);

      // Mini-"Puls" (kurz, dann Ruhe)
      // (Leaflet circleMarker radius lässt sich ändern)
      const pulse = L.circleMarker(latlng, {
        renderer: canvasRenderer,
        radius: 2,
        stroke: false,
        fill: true,
        fillOpacity: 0.75,
        fillColor: "rgba(255,245,235,1)"
      }).addTo(lightsLayer);

      let r = 2;
      const t = setInterval(() => {
        r += 1.2;
        pulse.setRadius(r);
        pulse.setStyle({ fillOpacity: Math.max(0, 0.75 - r * 0.08) });
        if (r > 12) { clearInterval(t); lightsLayer.removeLayer(pulse); }
      }, 60);
    }

    map.on("click", (e) => {
      addLight(e.latlng);
      // hier würdest du später an dein Backend POSTen:
      // fetch("/api/lights", {method:"POST", body: JSON.stringify(e.latlng), headers:{'Content-Type':'application/json'}})
    });

    function fitToWorld(){
      const layers = [];
      lightsLayer.eachLayer(l => layers.push(l));
      if (layers.length === 0){
        map.flyTo([20, 10], 2, { duration: 0.9 });
        return;
      }
      const bounds = L.latLngBounds([]);
      // jede zweite Markierung ist der Kern / Glow, egal: bounds über alle
      lightsLayer.eachLayer(l => {
        if (l.getLatLng) bounds.extend(l.getLatLng());
      });
      map.fitBounds(bounds.pad(0.35), { animate: true, duration: 0.9 });
    }

    document.getElementById("btnWorld").addEventListener("click", fitToWorld);

    document.getElementById("btnClear").addEventListener("click", () => {
      lightsLayer.clearLayers();
      map.flyTo([20, 10], 2, { duration: 0.9 });
    });

    /***** 3) Export als PNG (Karte generieren) *****/
    document.getElementById("btnExport").addEventListener("click", () => {
      // Für den "All"-Look: zuerst rauszoomen/fitten, dann exportieren
      fitToWorld();

      // warten bis Tiles & Render fertig sind
      setTimeout(() => {
        leafletImage(map, function(err, canvas) {
          if (err) { alert("Export fehlgeschlagen."); return; }
          const img = canvas.toDataURL("image/png");

          const a = document.createElement("a");
          a.href = img;
          a.download = "eine-menschheit-karte.png";
          a.click();
        });
      }, 900);
    });
  </script>
</body>
</html>
