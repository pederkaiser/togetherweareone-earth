<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Together We Are One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- PNG Export helper -->
  <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Together We Are One">
  <meta property="og:description" content="A quiet place. You set a light and see that many feel the same.">
  <meta property="og:image" content="https://togetherweareone.earth/TogetherWeAreOneEarth.jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="1200">
  <meta property="og:url" content="https://togetherweareone.earth/">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://togetherweareone.earth/TogetherWeAreOneEarth.jpeg">

  <style>

:root{
  --bg0:#0b0d12;
  --bg1:#121526;
  --card: rgba(255,255,255,0.06);
  --card2: rgba(255,255,255,0.08);
  --stroke: rgba(255,255,255,0.10);
  --ghost: rgba(255,255,255,0.25);
  --text: rgba(255,255,255,0.92);
  --warm: rgba(255,220,170,0.95);
  --shade-opacity: 0.10;
  --map-brightness: 0.65;
  --map-contrast: 1.0;
  --map-saturate: 0.0;
}

.leaflet-tile{
  filter:
    grayscale(1)
    brightness(var(--map-brightness))
    contrast(var(--map-contrast))
    saturate(var(--map-saturate));
}
    
html,body{
  height:100%;
  margin:0;
}

body{
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg0));
  font-family:system-ui,-apple-system,"Inter",sans-serif;
}


/* Layout */

.wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:30px 0;
}

.content{
  width:100%;
  max-width:1000px;
}


/* Cards */

.teleprompter,
.mapWrap{
  width:100%;
  border-radius:22px;
  border:1px solid rgba(255,255,255,0.08);
  box-shadow:0 25px 80px rgba(0,0,0,0.55);
}

.teleprompter{
  background:linear-gradient(
    180deg,
    rgba(255,255,255,0.06),
    rgba(255,255,255,0.03)
  );
  padding:28px 32px;
  margin-bottom:30px;
}

.mapWrap{
  position:relative;
  overflow:hidden;
  background:#0a0b10;
}


/* Map */

#map{
  width:100%;
  aspect-ratio: 16 / 9;
}

.leaflet-container{
  background:#0a0b10 !important;
  cursor:crosshair;
}


/* Subtiles Nacht-Softening */

.mapDarkOverlay{
  pointer-events:none;
  position:absolute;
  inset:0;
  z-index:1;
  background:
    radial-gradient(
      ellipse at center,
      rgba(0,0,0,0.05),
      rgba(0,0,0,0.15)
    );
}

/* HUD */

.hud{
  position:absolute;
  top:20px;
  left:20px;
  z-index:1000;
  display:flex;
  gap:12px;
}

.hud button{
  padding:10px 18px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.55);
  color:white;
  font-size:14px;
  backdrop-filter:blur(8px);
  cursor:pointer;
}


/* Prompter */

.tp-text{
  text-align:center;
  font-size:24px;
  line-height:1.5;
  min-height:3em;
}

.tp-word{
  color:var(--ghost);
  transition:0.2s;
}

.tp-word.done{
  color:var(--warm);
}

.tp-word.active{
  color:white;
}

.tp-meta{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
  margin-top:20px;
}

.tp-btn{
  padding:10px 16px;
  border-radius:10px;
  border:1px solid var(--stroke);
  background:var(--card2);
  color:white;
  cursor:pointer;
}
    
.tp-progress{
  width: min(500px, 60vw);
  height: 6px;
  border-radius: 6px;
  overflow: hidden;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.08);
  flex:1;
  max-width:420px;
}

.tp-progress-bar{
  height: 100%;
  width: 0%;
  background: linear-gradient(
    90deg,
    rgba(255,220,170,0.7),
    rgba(255,255,255,0.6)
  );
  transition: width 0.3s ease;
  transition: width 0.6s cubic-bezier(.4,0,.2,1);
}


/* Footer text */

.status,
.hint,
.privacy-hint{
  text-align:center;
  margin-top:14px;
  font-size:14px;
  opacity:0.7;
}


/* Attribution */

.leaflet-control-attribution{
  background:rgba(0,0,0,0.35) !important;
  color:rgba(255,255,255,0.65);
}


/* Lang badge */

#langBadge{
  position:fixed;
  top:15px;
  left:15px;
  font-size:12px;
  opacity:0.6;
}

</style>
</head>

<body>

<div id="langBadge"></div>

<div class="wrap">

  <div class="content">

    <div class="teleprompter">
      <p id="tp-text" class="tp-text"></p>

     <div class="tp-meta">
  <button id="tp-prev" class="tp-btn">‚Üê</button>

  <div class="tp-progress">
    <div class="tp-progress-bar" id="tp-bar"></div>
  </div>

  <button id="tp-next" class="tp-btn">‚Üí</button>
</div>
    </div>

    <div class="mapWrap">
      <div class="hud">
        <button id="btnWorld"></button>
        <button id="btnCard"></button>
      </div>

      <div id="map"></div>
      <div class="mapDarkOverlay"></div>
    </div>

    <p id="privacyHint" class="privacy-hint"></p>
    <p id="status" class="status"></p>
    <p id="hint" class="hint"></p>

  </div>
</div>

<script>

/* -------------------------
   1) Language Detection
-------------------------- */

function getLangFromUrl() {
  const p = new URLSearchParams(location.search);
  const v = (p.get("lang") || "").trim();
  return v ? v.toLowerCase() : null;
}

function normalizeLang(tag) {
  if (!tag) return "en";
  const t = tag.toLowerCase();
  if (t.startsWith("zh")) return "zh";
  if (t.startsWith("in")) return "id";
  if (t.startsWith("iw")) return "he";
  if (t.startsWith("pt")) return "pt";
  return t.split("-")[0];
}

const SUPPORTED = [
  "en","de","es","fr","pt","ru","ar","hi",
  "bn","ur","zh","ja","ko","vi","tr","sw","id"
];

function pickLanguage() {
  const urlLang = normalizeLang(getLangFromUrl());
  if (urlLang && SUPPORTED.includes(urlLang)) return urlLang;

  const prefs = (navigator.languages && navigator.languages.length)
    ? navigator.languages.map(normalizeLang)
    : [normalizeLang(navigator.language || "en")];

  for (const lang of prefs) {
    if (SUPPORTED.includes(lang)) return lang;
  }
  return "en";
}

const LANG = pickLanguage();
document.documentElement.lang = LANG;
document.getElementById("langBadge").textContent = LANG.toUpperCase();


/* -------------------------
   2) Teleprompter Text
-------------------------- */

const TP = {

  en: [
    "We almost never think about it.",
    "Our lives on this small blue planet in space.",
    "In this brief blink long after the Big Bang.",
    "That it exists at all ‚Äì as far as we know ‚Äì is unique.",
    "That makes us all special. And it connects us.",
    "Here you can place a light. And see that many feel the same."
  ],

  de: [
    "Wir denken fast nie daran.",
    "Unser Leben auf dieser kleinen blauen Kugel im Weltall.",
    "In diesem Augenzwinkern lange nach dem Urknall.",
    "Dass es das √ºberhaupt gibt ‚Äì nach allem was wir wissen ‚Äì ist einzigartig.",
    "Das macht uns alle besonders. Und es verbindet uns.",
    "Hier kannst du ein Licht setzen. Und sehen, dass viele dasselbe f√ºhlen."
  ],

  es: [
    "Casi nunca pensamos en ello.",
    "Nuestra vida en esta peque√±a esfera azul en el espacio.",
    "En este parpadeo fugaz mucho despu√©s del Big Bang.",
    "Que exista ‚Äì seg√∫n todo lo que sabemos ‚Äì es √∫nico.",
    "Eso nos hace especiales a todos. Y nos conecta.",
    "Aqu√≠ puedes colocar una luz. Y ver que muchos sienten lo mismo."
  ],

  fr: [
    "Nous n‚Äôy pensons presque jamais.",
    "√Ä notre vie sur cette petite plan√®te bleue dans l‚Äôespace.",
    "Dans ce clin d‚Äô≈ìil fugace longtemps apr√®s le Big Bang.",
    "Le fait que cela existe ‚Äì selon ce que nous savons ‚Äì est unique.",
    "Cela nous rend tous particuliers. Et nous relie.",
    "Ici, tu peux placer une lumi√®re. Et voir que beaucoup ressentent la m√™me chose."
  ]

};


/* -------------------------
   3) UI Text
-------------------------- */

const UI = {

  en: {
    world: "World view",
    card: "Generate map",
    hint: "Click on the map to place or move your light. (One light per browser.)",
    privacy: "Lights are anonymous and rounded to about 10 km.",
    status_empty: "Place your light by clicking on the map.",
    status_set: "Your light is set. You can move it by clicking on the map.",
    status_export: "Creating image‚Ä¶",
    status_done: "Done."
  },

  de: {
    world: "Weltansicht",
    card: "Karte generieren",
    hint: "Klicke auf die Karte, um dein Licht zu setzen oder zu verschieben.",
    privacy: "Lichter sind anonym und auf etwa 10 km gerundet.",
    status_empty: "Setze dein Licht mit einem Klick.",
    status_set: "Dein Licht ist gesetzt.",
    status_export: "Erzeuge Bild‚Ä¶",
    status_done: "Fertig."
  },

  es: {
    world: "Vista mundial",
    card: "Generar mapa",
    hint: "Haz clic en el mapa para colocar o mover tu luz.",
    privacy: "Las luces son an√≥nimas y redondeadas a unos 10 km.",
    status_empty: "Coloca tu luz haciendo clic.",
    status_set: "Tu luz est√° colocada.",
    status_export: "Creando imagen‚Ä¶",
    status_done: "Listo."
  },

  fr: {
    world: "Vue du monde",
    card: "G√©n√©rer la carte",
    hint: "Cliquez sur la carte pour placer ou d√©placer votre lumi√®re.",
    privacy: "Les lumi√®res sont anonymes et arrondies √† environ 10 km.",
    status_empty: "Placez votre lumi√®re.",
    status_set: "Votre lumi√®re est plac√©e.",
    status_export: "Cr√©ation de l‚Äôimage‚Ä¶",
    status_done: "Termin√©."
  }

};


const UI_TEXT = UI[LANG] || UI.en;
const tpTexts = TP[LANG] || TP.en;

document.getElementById("btnWorld").textContent = UI_TEXT.world;
document.getElementById("btnCard").textContent  = UI_TEXT.card;
document.getElementById("hint").textContent     = UI_TEXT.hint;
document.getElementById("privacyHint").textContent = UI_TEXT.privacy;
/* -------------------------
   4) Teleprompter (word-by-word + line breaks)
-------------------------- */

const CHAR_BASED_LANGS = ["zh","ja","ko"];
const WORD_MS = (CHAR_BASED_LANGS.includes(LANG) ? 190 : 240);
const SENTENCE_PAUSE = 900;

let tpIndex = 0;
let tpUnitIdx = 0;
let tpTimer = null;

const tpTextEl = document.getElementById("tp-text");
const tpBarEl  = document.getElementById("tp-bar");

function updateProgress(){
  if(!tpBarEl) return;
  tpBarEl.style.width =
    `${100 * (tpIndex + 1) / tpTexts.length}%`;
}

function renderSentence(sentence){
  // keep old behavior: allow \n inside strings
  const s = (sentence || "").replace(/\n/g, " \n ");
  const tokens = s.split(/(\s+)/);

  tpTextEl.innerHTML = tokens.map(t => {
    if (t === "\n") return `<span class="tp-br"></span>`;
    if (/^\s+$/.test(t)) return `<span class="tp-space">${t}</span>`;
    return `<span class="tp-word">${t}</span>`;
  }).join("");
}

function getUnits(sentence){
  const s = sentence || "";
  if (CHAR_BASED_LANGS.includes(LANG)) {
    return Array.from(s.replace(/\s+/g, ""));
  }
  return s
    .replace(/\n/g, " ")
    .split(/\s+/)
    .filter(Boolean);
}

function markProgress(activeIdx){
  const wordSpans = Array.from(tpTextEl.querySelectorAll(".tp-word"));
  wordSpans.forEach((w, i) => {
    w.classList.remove("active");
    if (i <= activeIdx) w.classList.add("done");
    else w.classList.remove("done");
  });
  if (wordSpans[activeIdx]) wordSpans[activeIdx].classList.add("active");
}

function playSentence(idx, auto=true){
  clearInterval(tpTimer);
  tpIndex = idx;
  tpUnitIdx = 0;

  renderSentence(tpTexts[tpIndex]);
  updateProgress();
  const units = getUnits(tpTexts[tpIndex]);
  markProgress(0);

  tpTimer = setInterval(() => {
    tpUnitIdx++;
    if (tpUnitIdx < units.length) {
      markProgress(tpUnitIdx);
    } else {
      clearInterval(tpTimer);
      markProgress(Math.max(0, units.length - 1));
      if (auto) {
        setTimeout(() => {
          if (tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, true);
        }, SENTENCE_PAUSE);
      }
    }
  }, WORD_MS);
}

document.getElementById("tp-prev").addEventListener("click", () => {
  if (tpIndex > 0) playSentence(tpIndex - 1, false);
});
document.getElementById("tp-next").addEventListener("click", () => {
  if (tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, false);
});

playSentence(0, true);

/* -------------------------
   5) Share (native share sheet + fallback copy)
-------------------------- */

const SHARE_MAIN_LABEL = {
  de: "Mit einer Freundin oder einem Freund teilen",
  en: "Share with a friend",
  fr: "Partager avec un ami",
  es: "Compartir con un amigo",
  pt: "Compartilhar com um amigo",
  ru: "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–≥–æ–º",
  ar: "ÿ¥ÿßÿ±ŸÉ ŸÖÿπ ÿµÿØŸäŸÇ",
  hi: "‡§ï‡§ø‡§∏‡•Ä ‡§¶‡•ã‡§∏‡•ç‡§§ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç",
  bn: "‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®",
  ur: "⁄©ÿ≥€å ÿØŸàÿ≥ÿ™ ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ¥€åÿ¶ÿ± ⁄©ÿ±€å⁄∫",
  zh: "ÂàÜ‰∫´ÁªôÊúãÂèã",
  ja: "Âèã„Å†„Å°„Å®ÂÖ±Êúâ„Åô„Çã",
  ko: "ÏπúÍµ¨ÏôÄ Í≥µÏú†ÌïòÍ∏∞",
  vi: "Chia s·∫ª v·ªõi m·ªôt ng∆∞·ªùi b·∫°n",
  tr: "Bir arkada≈üƒ±nla payla≈ü",
  sw: "Shiriki na rafiki",
  id: "Bagikan dengan seorang teman"
};

const SHARE_TEXT = {
  de: "Eine stille Seite. Man setzt ein Licht und sieht, dass viele dasselbe f√ºhlen.",
  en: "A quiet place. You set a light and see that many feel the same.",
  es: "Un lugar tranquilo. Pones una luz y ves que muchos sienten lo mismo.",
  fr: "Un endroit calme. On y place une lumi√®re et on voit que beaucoup ressentent la m√™me chose.",
  pt: "Um lugar tranquilo. Voc√™ coloca uma luz e v√™ que muitos sentem o mesmo.",
  ru: "–¢–∏—Ö–æ–µ –º–µ—Å—Ç–æ. –¢—ã –∑–∞–∂–∏–≥–∞–µ—à—å —Å–≤–µ—Ç –∏ –≤–∏–¥–∏—à—å, —á—Ç–æ –º–Ω–æ–≥–∏–µ —á—É–≤—Å—Ç–≤—É—é—Ç —Ç–æ –∂–µ —Å–∞–º–æ–µ.",
  ar: "ŸÖŸÉÿßŸÜ ŸáÿßÿØÿ¶. ÿ™ÿ∂ÿπ ŸÜŸàÿ±Ÿãÿß Ÿàÿ™ÿ±Ÿâ ÿ£ŸÜ ŸÉÿ´Ÿäÿ±ŸäŸÜ Ÿäÿ¥ÿπÿ±ŸàŸÜ ÿ®ÿßŸÑÿ¥Ÿäÿ° ŸÜŸÅÿ≥Ÿá.",
  hi: "‡§è‡§ï ‡§∂‡§æ‡§Ç‡§§ ‡§ú‡§ó‡§π‡•§ ‡§Ü‡§™ ‡§è‡§ï ‡§∞‡•ã‡§∂‡§®‡•Ä ‡§∞‡§ñ‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§¶‡•á‡§ñ‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§¨‡§π‡•Å‡§§ ‡§∏‡•á ‡§≤‡•ã‡§ó ‡§µ‡§π‡•Ä ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§",
  bn: "‡¶è‡¶ï‡¶ü‡¶ø ‡¶∂‡¶æ‡¶®‡ßç‡¶§ ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡•§ ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶≤‡ßã ‡¶¨‡¶∏‡¶æ‡¶ì ‡¶è‡¶¨‡¶Ç ‡¶¶‡ßá‡¶ñ‡ßã ‡¶Ø‡ßá ‡¶Ö‡¶®‡ßá‡¶ï‡ßá‡¶á ‡¶è‡¶ï‡¶á ‡¶Ö‡¶®‡ßÅ‡¶≠‡¶¨ ‡¶ï‡¶∞‡ßá‡•§",
  ur: "ÿß€å⁄© ÿÆÿßŸÖŸàÿ¥ ÿ¨⁄Ø€Å€î ÿ¢Ÿæ ÿß€å⁄© ÿ±Ÿàÿ¥ŸÜ€å ÿ±⁄©⁄æÿ™€í €Å€å⁄∫ ÿßŸàÿ± ÿØ€å⁄©⁄æÿ™€í €Å€å⁄∫ ⁄©€Å ÿ®€Åÿ™ ÿ≥€í ŸÑŸà⁄Ø Ÿà€Å€å ŸÖÿ≠ÿ≥Ÿàÿ≥ ⁄©ÿ±ÿ™€í €Å€å⁄∫€î",
  zh: "‰∏Ä‰∏™ÂÆâÈùôÁöÑÂú∞Êñπ„ÄÇ‰Ω†ÁÇπ‰∫Æ‰∏ÄÁõèÁÅØÔºåÁúãÂà∞ËÆ∏Â§ö‰∫∫ÊúâÁùÄÁõ∏ÂêåÁöÑÊÑüÂèó„ÄÇ",
  ja: "Èùô„Åã„Å™Â†¥ÊâÄ„ÄÇÂÖâ„ÇíÁΩÆ„Åè„Å®„ÄÅÂêå„Åò„Çà„ÅÜ„Å´ÊÑü„Åò„Å¶„ÅÑ„Çã‰∫∫„Åå„Åü„Åè„Åï„Çì„ÅÑ„Çã„Åì„Å®„Åå„Çè„Åã„Çä„Åæ„Åô„ÄÇ",
  ko: "Ï°∞Ïö©Ìïú Í≥µÍ∞Ñ. ÎπõÏùÑ ÎÜìÏúºÎ©¥ ÎßéÏùÄ ÏÇ¨ÎûåÎì§Ïù¥ Í∞ôÏùÄ Í∞êÏ†ïÏùÑ ÎäêÎÅºÍ≥† ÏûàÏùåÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§.",
  vi: "M·ªôt n∆°i y√™n tƒ©nh. B·∫°n ƒë·∫∑t m·ªôt √°nh s√°ng v√† th·∫•y r·∫±ng nhi·ªÅu ng∆∞·ªùi c≈©ng c·∫£m nh·∫≠n nh∆∞ v·∫≠y.",
  tr: "Sessiz bir yer. Bir ƒ±≈üƒ±k bƒ±rakƒ±rsƒ±n ve bir√ßok ki≈üinin aynƒ± ≈üeyi hissettiƒüini g√∂r√ºrs√ºn.",
  sw: "Mahali tulivu. Unaweka mwanga na kuona kwamba wengi wanahisi vivyo hivyo.",
  id: "Tempat yang tenang. Kamu menempatkan sebuah cahaya dan melihat bahwa banyak yang merasakan hal yang sama."
};

function shareUrlForLang() {
  return `${location.origin}/?lang=${encodeURIComponent(LANG)}`;
}

function ensureShareButton(){
  // Share button exists in your original file; in this trimmed HTML version we didn't render it
  // So: create if missing, to keep full functionality intact
  let btn = document.getElementById("shareMain");
  if (!btn) {
    const tp = document.querySelector(".teleprompter");
    const wrap = document.createElement("div");
    wrap.style.display = "flex";
    wrap.style.justifyContent = "center";
    wrap.style.marginTop = "12px";

    btn = document.createElement("button");
    btn.id = "shareMain";
    btn.type = "button";
    btn.className = "tp-btn";
    btn.style.borderRadius = "999px";
    btn.style.padding = "10px 16px";
    wrap.appendChild(btn);
    tp.appendChild(wrap);
  }

  btn.textContent = SHARE_MAIN_LABEL[LANG] || SHARE_MAIN_LABEL.en;

  btn.addEventListener("click", async () => {
    const url = shareUrlForLang();
    const text = SHARE_TEXT[LANG] || SHARE_TEXT.en;

    if (navigator.share) {
      try {
        await navigator.share({
          title: "Together We Are One",
          text,
          url
        });
      } catch (_) {}
      return;
    }

    try {
      await navigator.clipboard.writeText(url);
      alert("Link copied");
    } catch (_) {
      prompt("", url);
    }
  });
}
ensureShareButton();


/* -------------------------
   6) Supabase + Status
-------------------------- */

function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

const SUPABASE_URL = 'https://gwfqdukbcgtcefqtgnbl.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3ZnFkdWtiY2d0Y2VmcXRnbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDU2MTMsImV4cCI6MjA4NDI4MTYxM30.ePyuDxhVoc1ol5lQ8JbRKaybgpEPozBR3Wf71oFj040';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let session = localStorage.getItem('myLightSession');
if(!session){
  session = uuidv4();
  localStorage.setItem('myLightSession', session);
}

const statusEl = document.getElementById("status");

function setStatus(key){
  const v = UI_TEXT[key] || key || "";
  statusEl.textContent = v;
}

/* -------------------------
   7) Map
-------------------------- */

// Welt-Grenzen (wie bei dir)
const WORLD_BOUNDS = L.latLngBounds(
  L.latLng(-60, -180),
  L.latLng(85, 180)
);

// Start-View (wird zus√§tzlich noch hart auf WORLD_BOUNDS gefittet)
const WORLD_VIEW = { center: [20, 0], zoom: 2.0 };

// Hilfsfunktion: 2 Frames warten (gegen Race Conditions bei Resize/Fonts/Mobile Address Bar)
function afterTwoFrames(fn){
  requestAnimationFrame(() => requestAnimationFrame(fn));
}

// Map initialisieren (noch nicht setView -> wir fitten stabil in whenReady)
const map = L.map('map', {
  zoomControl: true,
  worldCopyJump: false,
  zoomSnap: 0.25,
  zoomDelta: 0.25,
  maxBounds: WORLD_BOUNDS,
  maxBoundsViscosity: 1.0
});

// definierter Start
map.setView(WORLD_VIEW.center, WORLD_VIEW.zoom, { animate: false });

// WICHTIG: Funktion f√ºr stabile Weltansicht (immer komplett)
function goWorld(animate=false){
  map.fitBounds(WORLD_BOUNDS, { padding: [0,0], animate });
}

// Beim ersten Laden: Map-Container finalisieren + Weltansicht erzwingen
map.whenReady(() => {
  afterTwoFrames(() => {
    map.invalidateSize(true);
    map.setZoom(map.getZoom() + 0.1);
    goWorld(false);
  });
});

// BFCache / Safari: Seite kommt aus Cache -> alte View wieder da -> erneut Weltansicht erzwingen
window.addEventListener("pageshow", () => {
  afterTwoFrames(() => {
    map.invalidateSize(true);
    goWorld(false);
  });
});

// Resize: nur invalidateSize, NICHT goWorld (sonst nervt es beim Nutzer)
let _resizeT = null;
window.addEventListener("resize", () => {
  clearTimeout(_resizeT);
  _resizeT = setTimeout(() => map.invalidateSize(true), 150);
});


// Tiles (wie bei dir)
// Bildschirm-Tiles (graue Version mit Labels)
const voyagerTiles = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
  {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    maxZoom: 18,
    noWrap: true,
    bounds: WORLD_BOUNDS,
    crossOrigin: true
  }
).addTo(map);

// Export-Tiles (echtes dunkles Grau)
const exportTiles = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
  {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    maxZoom: 18,
    noWrap: true,
    bounds: WORLD_BOUNDS,
    crossOrigin: true
  }
);
  

const baseNoLabels = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
  {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    maxZoom: 18,
    noWrap: true,
    bounds: WORLD_BOUNDS,
    crossOrigin: true
  }
);

// Canvas Renderer + Layergroup f√ºr Lichter
const canvasRenderer = L.canvas({ padding: 0.5 });
const lightsLayer = L.layerGroup().addTo(map);
let myExactLatLng = null;


// anonymisieren (wie bei dir)
function anonymize(lat, lng) {
  const GRID = 0.1; // ~11km
  return {
    lat: Math.round(lat / GRID) * GRID,
    lng: Math.round(lng / GRID) * GRID
  };
}


// Ghost-Licht (Cursor)
const ghost = L.circleMarker([0,0], {
  renderer: canvasRenderer,
  radius: 10,
  stroke: false,
  fill: true,
  fillOpacity: 0.0,
  fillColor: "rgba(255,220,170,1)",
  interactive: false
}).addTo(map);

const ghostCore = L.circleMarker([0,0], {
  renderer: canvasRenderer,
  radius: 2.2,
  stroke: false,
  fill: true,
  fillOpacity: 0.0,
  fillColor: "rgba(255,250,245,1)",
  interactive: false
}).addTo(map);

map.on("mouseover", () => {
  ghost.setStyle({ fillOpacity: 0.10 });
  ghostCore.setStyle({ fillOpacity: 0.75 });
});
map.on("mouseout", () => {
  ghost.setStyle({ fillOpacity: 0.0 });
  ghostCore.setStyle({ fillOpacity: 0.0 });
});
map.on("mousemove", (e) => {
  ghost.setLatLng(e.latlng);
  ghostCore.setLatLng(e.latlng);
});


// Lichter zeichnen
function addLight(latlng, isMine=false){
  if(!isMine){
    L.circleMarker(latlng, {
      renderer: canvasRenderer,
      radius: 1.35,
      stroke: false,
      fill: true,
      fillOpacity: 0.70,
      fillColor: "rgba(255,250,245,1)",
      interactive: false
    }).addTo(lightsLayer);
    return;
  }

  L.circleMarker(latlng, {
    renderer: canvasRenderer,
    radius: 2.6,
    stroke: false,
    fill: true,
    fillOpacity: 0.95,
    fillColor: "rgba(255,250,245,1)",
    interactive: true
  }).addTo(lightsLayer);
}


// Supabase Daten holen
async function loadMyLight(){
  const { data } = await sb.from('lights').select('*').eq('session', session).maybeSingle();
  return data;
}

let allLightPoints = [];

async function loadLights(){
  try{
    const { data, error } = await sb.from('lights').select('*');
    if(error) throw error;

    lightsLayer.clearLayers();

    let mine = null;
    for(const row of (data || [])){
      const isMine = (row.session === session);
      if(isMine) mine = row;
      if (isMine && myExactLatLng) {
  addLight([myExactLatLng.lat, myExactLatLng.lng], true);
} else {
  addLight([row.lat, row.lng], isMine);
}
    }

    allLightPoints = data || [];

    // hint handling
    const hintEl = document.getElementById("hint");
    if (mine) {
      hintEl.style.display = "none";
      setStatus("status_set");
    } else {
      hintEl.style.display = "block";
      setStatus("status_empty");
    }

  }catch(e){
    console.error(e);
    setStatus("status_error_load");
  }
}


// Klick -> Licht setzen / verschieben
map.on('click', async (e) => {

  try {

    const clickedLatLng = e.latlng;
    const anonymized = anonymize(clickedLatLng.lat, clickedLatLng.lng);

    // üëá Exakte Position lokal merken
    myExactLatLng = clickedLatLng;

    const existing = await loadMyLight();

    if(existing){
      await sb.from('lights')
        .update({ lat: anonymized.lat, lng: anonymized.lng })
        .eq('session', session);
    } else {
      await sb.from('lights')
        .insert({ lat: anonymized.lat, lng: anonymized.lng, session });
    }

    await loadLights();

  } catch(err){
    console.error(err);
  }

});


// Weltansicht Button
document.getElementById("btnWorld").addEventListener("click", () => {
  goWorld(true);
});

/* -------------------------
   8) Export (robust, no offsets)
-------------------------- */

// wait helper: moveend (mit Fallback)
function waitMoveEnd(m) {
  return new Promise(resolve => {
    let done = false;
    const finish = () => {
      if(done) return;
      done = true;
      m.off("moveend", finish);
      resolve();
    };
    m.once("moveend", finish);
    setTimeout(finish, 450);
  });
}

// wait helper: tiles loaded (mit Fallback)
function waitTiles(layer){
  return new Promise(resolve => {
    let done = false;
    const finish = () => {
      if(done) return;
      done = true;
      layer.off("load", finish);
      requestAnimationFrame(() => requestAnimationFrame(resolve));
    };
    layer.once("load", finish);
    setTimeout(finish, 1800);
  });
}

console.log("Export points:", allLightPoints);
  
// WICHTIG: Export-Lichter als SVG (kein Canvas Renderer) -> verhindert "Versatz" in leaflet-image
function buildExportLightsLayer(points, mySession) {
  const exportLayer = L.layerGroup();

  for (const row of (points || [])) {
    const isMine = (row.session === mySession);

    L.circleMarker([row.lat, row.lng], {
      // KEIN renderer => Leaflet SVG
      radius: isMine ? 2.6 : 1.35,
      stroke: false,
      fill: true,
      fillOpacity: isMine ? 0.95 : 0.70,
      fillColor: "rgba(255,250,245,1)",
      interactive: false
    }).addTo(exportLayer);
  }

  return exportLayer;
}

const btnCard = document.getElementById("btnCard");

btnCard.addEventListener("click", async () => {

  try {

    btnCard.disabled = true;
    setStatus("status_export");

    // üåç Bildschirm-Tiles entfernen
    map.removeLayer(voyagerTiles);
    
    // Canvas-Lichter entfernen
    map.removeLayer(lightsLayer);

    // SVG-Lichter f√ºr Export erzeugen
    const exportLights = buildExportLightsLayer(allLightPoints, session);
    exportLights.addTo(map);

    // üåë Export-Tiles hinzuf√ºgen
    exportTiles.addTo(map);

    goWorld(false);
    await waitMoveEnd(map);
    await new Promise(r => setTimeout(r, 600));

    leafletImage(map, function(err, canvas) {

      // üîÑ Export-Tiles wieder entfernen
      map.removeLayer(exportTiles);

      // üåç Bildschirm-Tiles zur√ºck
      voyagerTiles.addTo(map);
      // Export-Lichter entfernen
      map.removeLayer(exportLights);

      // Canvas-Lichter wieder hinzuf√ºgen
      lightsLayer.addTo(map);

      btnCard.disabled = false;

      if (err) {
        console.error(err);
        setStatus("status_error_save");
        return;
      }

      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "together-we-are-one.png";
      link.click();

      setStatus("status_done");
    });

  } catch(e){
    console.error(e);

    // Falls etwas schiefgeht ‚Üí Tiles zur√ºcksetzen
    if (map.hasLayer(exportTiles)) {
      map.removeLayer(exportTiles);
      voyagerTiles.addTo(map);
    }

    btnCard.disabled = false;
    setStatus("status_error_save");
  }

});


/* -------------------------
   9) Start
-------------------------- */

// erste Ladung + Auto-Refresh
loadLights();
setInterval(loadLights, 30000);

</script>
</body>
</html>
