<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Together We Are One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- PNG Export helper -->
  <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>

  <style>
    :root{
      --bg0:#0b0d12;
      --bg1:#121526;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);

      --ghost: rgba(255,255,255,0.22);
      --text: rgba(255,255,255,0.92);
      --warm: rgba(255,220,170,0.95);

      /* Anzeige-Look (fix, ohne User-Regler) */
      --map-brightness: 0.64;
      --map-contrast: 1.25;
      --map-saturate: 0.0;   /* Graustufe */
      --shade-opacity: 0.90;
      --ocean-tint: rgba(0,0,0,0.38);
    }

    html,body { height:100%; }
    body{
      margin:0;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 50% 12%, rgba(40,60,110,0.35) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(900px 520px at 20% 8%, rgba(130,90,40,0.18) 0%, rgba(0,0,0,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Inter", "Segoe UI", Arial, sans-serif;
      overflow-x:hidden;
    }

    .wrap{
      min-height:100%;
      display:grid;
      grid-template-rows:auto auto 1fr auto;
      gap:14px;
      padding:18px 14px;
      box-sizing:border-box;
      max-width:1100px;
      margin:0 auto;
    }

    /* --- Prompter --- */
    .teleprompter{
      padding:18px 18px 14px 18px;
      border-radius:20px;
      background: linear-gradient(180deg, var(--card2), var(--card));
      border: 1px solid var(--stroke);
      box-shadow: 0 16px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
    }
    .tp-text{
      text-align:center;
      font-size: clamp(18px, 2.5vw, 30px);
      line-height:1.45;
      letter-spacing:0.2px;
      margin:0;
      padding:8px 10px 10px 10px;
      min-height:3.2em;
    }
    /* Zeilenumbruch: aktiv */
    .tp-word{
      color: var(--ghost);
      transition: color 160ms ease, filter 160ms ease;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .tp-space{ white-space: pre; }
    .tp-word.done{
      color: var(--warm);
      filter: drop-shadow(0 0 12px rgba(255,210,140,0.18));
    }
    .tp-word.active{
      color: rgba(255,245,235,0.98);
      filter: drop-shadow(0 0 18px rgba(255,210,140,0.26));
    }

    .tp-meta{
      display:flex; align-items:center; justify-content:center;
      gap:10px; margin-top:8px; user-select:none;
    }
    .tp-btn{
      width:42px; height:42px; border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.85);
      cursor:pointer;
      transition: background 140ms ease, transform 140ms ease;
      font-size:18px; font-weight:700;
    }
    .tp-btn:hover{ background: rgba(255,255,255,0.10); transform: translateY(-1px); }

    .tp-progress{
      width: min(520px, 62vw);
      height:8px;
      border-radius:8px;
      overflow:hidden;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.08);
    }
    .tp-progress-bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,220,170,0.65), rgba(255,255,255,0.55));
      transition: width 220ms ease;
    }

    /* --- Map --- */
    .mapWrap{
      position:relative;
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.10);
      box-shadow: 0 16px 60px rgba(0,0,0,0.35);
      background:#0a0b10;
    }
    #map{ width:100%; height: min(62vh, 520px); }

    /* On-screen: Graustufe + dunkler */
    .leaflet-tile{
      filter:
        grayscale(1)
        brightness(var(--map-brightness))
        contrast(var(--map-contrast))
        saturate(var(--map-saturate));
    }

    .mapTint{
      pointer-events:none;
      position:absolute; inset:0;
      background: var(--ocean-tint);
      mix-blend-mode: multiply;
      opacity:1;
    }
    .mapShade{
      pointer-events:none;
      position:absolute; inset:0;
      opacity: var(--shade-opacity);
      background:
        radial-gradient(900px 420px at 50% 10%, rgba(0,0,0,0.18), rgba(0,0,0,0.86) 65%),
        radial-gradient(700px 520px at 10% 80%, rgba(0,0,0,0.12), rgba(0,0,0,0.78) 72%),
        linear-gradient(180deg, rgba(0,0,0,0.14), rgba(0,0,0,0.70));
      mix-blend-mode: multiply;
    }

    .hud{
      position:absolute;
      left:12px; top:12px;
      display:flex; gap:10px;
      z-index:500;
      flex-wrap:wrap;
      align-items:center;
    }
    .hud button{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.24);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: background 140ms ease, transform 140ms ease;
      font-weight:650;
      letter-spacing:0.2px;
    }
    .hud button:hover{ background: rgba(0,0,0,0.32); transform: translateY(-1px); }

    .hint{ text-align:center; margin:4px 0 0 0; color: rgba(255,255,255,0.60); font-size:14px; }
    .status{ text-align:center; color: rgba(255,255,255,0.70); font-size:13px; margin-top:6px; }

    @media (max-width:600px){
      .wrap{ padding:12px 10px; }
      .teleprompter{ padding:14px 12px 12px 12px; border-radius:18px; }
      .tp-btn{ width:40px; height:40px; border-radius:14px; }
      #map{ height:52vh; }
    }
    #langBadge{
  position: fixed;
  left: 10px;
  top: 10px;
  z-index: 9999;
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(0,0,0,0.25);
  color: rgba(255,255,255,0.85);
  font: 600 12px/1 ui-sans-serif, system-ui, -apple-system, "Inter", "Segoe UI", Arial, sans-serif;
  letter-spacing: 0.08em;
  backdrop-filter: blur(8px);
}
  </style>
</head>

<body>
  <div id="langBadge" aria-label="Language"></div>
  <div class="wrap">

    <div class="teleprompter" aria-label="Text">
      <p class="tp-text" id="tp-text"></p>
      <div class="tp-meta">
        <button class="tp-btn" id="tp-prev" title="Zurück" aria-label="Zurück">←</button>
        <div class="tp-progress"><div class="tp-progress-bar" id="tp-bar"></div></div>
        <button class="tp-btn" id="tp-next" title="Weiter" aria-label="Weiter">→</button>
      </div>
    </div>

    <div class="mapWrap" id="mapWrap">
      <div class="hud">
        <button id="btnWorld" title="Ein Erdball (ohne Wrap / ohne doppelte Kontinente)">Weltansicht</button>
        <button id="btnCard" title="Screenshot vom Erdball (Graustufe, dunkel, mit Lichtern)">Karte generieren</button>
      </div>

      <div id="map"></div>
      <div class="mapTint"></div>
      <div class="mapShade"></div>
    </div>

    <p class="hint">Klicke auf die Karte, um dein Licht zu setzen oder zu verschieben. (Nur ein Licht pro Browser.)</p>
    <p class="status" id="status"></p>
  </div>

<script>
/* -------------------------
   1) PROMPTER (unverändert, mit Zeilenumbruch)
-------------------------- */
// --- Language selection (URL override ?lang=xx, otherwise browser) ---
function getLangFromUrl() {
  const p = new URLSearchParams(location.search);
  const v = (p.get("lang") || "").trim();
  return v ? v.toLowerCase() : null;
}

function normalizeLang(tag) {
  if (!tag) return "en";
  const t = tag.toLowerCase();

  // Chinese script handling
  if (t.startsWith("zh")) return "zh";

  // Map "in" to "id" (old code), "iw" to "he" etc.
  if (t.startsWith("in")) return "id";
  if (t.startsWith("iw")) return "he";

  // Use primary subtag: "de-de" -> "de"
  return t.split("-")[0];
}

const SUPPORTED = ["en","es","hi","zh","ar","ru","de"]; // de optional for you

function pickLanguage() {
  // 1) URL override
  const urlLang = normalizeLang(getLangFromUrl());
  if (urlLang && SUPPORTED.includes(urlLang)) return urlLang;

  // 2) Browser preferences
  const prefs = (navigator.languages && navigator.languages.length)
    ? navigator.languages
    : [navigator.language || "en"];

  for (const tag of prefs) {
    const base = normalizeLang(tag);
    if (SUPPORTED.includes(base)) return base;
  }

  // 3) fallback
  return "en";
}

const LANG = pickLanguage();
const badge = document.getElementById("langBadge");
if (badge) badge.textContent = LANG.toUpperCase();

// --- Teleprompter texts per language ---
const TP = {
  de: [
    "Manchmal schauen wir in den Himmel.",
    "Vielleicht sehen wir einen Stern, den Mond, ferne Galaxien.",
    "Für einen Moment wird uns bewusst, wie klein unser Planet ist.",
    "Wie selten – vielleicht sogar einzigartig – das Leben hier ist.",
    "Auf diesem winzigen Punkt im Weltall teilen wir unser Leben.",
    "Jeder von uns mit einer eigenen Geschichte, aber doch alle miteinander verbunden.",
    "Nicht durch Herkunft, Sprache oder Grenzen – sondern durch das Glück, gemeinsam hier zu sein.",
    "Manche Menschen spüren in solchen Momenten, dass wir eigentlich eine einzige Gemeinschaft sind.",
    "Dass uns mehr verbindet als trennt.",
    "Hast du das auch schon einmal gefühlt?",
    "Helf’ uns, dieses Gefühl sichtbar zu machen!"
  ],

  en: [
    "Sometimes we look up at the sky.",
    "Maybe we see a star, the Moon, distant galaxies.",
    "For a moment, we realize how small our planet is.",
    "How rare — perhaps even unique — life here may be.",
    "On this tiny point in the universe, we share our lives.",
    "Each of us with our own story — and yet all connected.",
    "Not by origin, language, or borders — but by the gift of being here together.",
    "In moments like this, some people feel we are one single community.",
    "That what connects us is greater than what divides us.",
    "Have you ever felt that too?",
    "Help us make this feeling visible."
  ],

  es: [
    "A veces miramos al cielo.",
    "Quizá vemos una estrella, la Luna, galaxias lejanas.",
    "Por un momento, nos damos cuenta de lo pequeño que es nuestro planeta.",
    "De lo raro — quizá incluso único — que es que exista vida aquí.",
    "En este pequeño punto del universo compartimos nuestras vidas.",
    "Cada uno con su propia historia, y aun así conectados.",
    "No por origen, idioma o fronteras, sino por el regalo de estar aquí juntos.",
    "En momentos así, algunas personas sienten que somos una sola comunidad.",
    "Que lo que nos une es más grande que lo que nos separa.",
    "¿Alguna vez lo has sentido también?",
    "Ayúdanos a hacer visible este sentimiento."
  ],

  hi: [
    "कभी-कभी हम आकाश की ओर देखते हैं।",
    "शायद हम कोई तारा, चाँद, दूर की आकाशगंगाएँ देखते हैं।",
    "एक पल के लिए हमें एहसास होता है कि हमारा ग्रह कितना छोटा है।",
    "और यहाँ जीवन कितना दुर्लभ — शायद अनोखा — हो सकता है।",
    "इस छोटे से बिंदु पर, हम अपनी ज़िंदगियाँ साझा करते हैं।",
    "हर किसी की अपनी कहानी है, और फिर भी हम जुड़े हुए हैं।",
    "जन्म, भाषा या सीमाओं से नहीं — बल्कि साथ यहाँ होने के उपहार से।",
    "ऐसे क्षणों में कुछ लोग महसूस करते हैं कि हम एक ही समुदाय हैं।",
    "कि जो हमें जोड़ता है, वह जो हमें बाँटता है उससे बड़ा है।",
    "क्या आपने भी कभी ऐसा महसूस किया है?",
    "इस भावना को दृश्य बनाने में हमारी मदद करें।"
  ],

  zh: [
    "有时我们会仰望天空。",
    "也许我们看见一颗星、月亮，或遥远的星系。",
    "在那一瞬间，我们意识到地球是多么渺小。",
    "这里的生命是多么稀有——也许甚至独一无二。",
    "在宇宙这个小小的点上，我们共享人生。",
    "我们各有故事，却彼此相连。",
    "不是因为出身、语言或边界，而是因为我们能一起在这里。",
    "在这样的时刻，有些人会感到：我们是同一个共同体。",
    "连接我们的，比分隔我们的更多。",
    "你也曾有过这种感觉吗？",
    "帮助我们让这种感觉变得可见。"
  ],

  ar: [
    "أحيانًا ننظر إلى السماء.",
    "قد نرى نجمةً أو القمرَ أو مجرّاتٍ بعيدة.",
    "وفي لحظةٍ ما ندرك كم كوكبُنا صغير.",
    "وكم أن الحياة هنا نادرة — وربما فريدة.",
    "على هذه النقطة الصغيرة في الكون نتشارك حياتنا.",
    "لكلٍّ منا قصته، ومع ذلك نحن مترابطون.",
    "ليس بالأصل أو اللغة أو الحدود — بل بهبة وجودنا هنا معًا.",
    "في مثل هذه اللحظات يشعر بعض الناس أننا مجتمعٌ واحد.",
    "وأن ما يجمعنا أكبر مما يفرّقنا.",
    "هل شعرتَ بهذا من قبل؟",
    "ساعدنا على جعل هذا الشعور مرئيًا."
  ],

  ru: [
    "Иногда мы смотрим в небо.",
    "Может быть, видим звезду, Луну, далёкие галактики.",
    "И на мгновение понимаем, насколько мала наша планета.",
    "Насколько редка — возможно, даже уникальна — жизнь здесь.",
    "На этой крошечной точке во Вселенной мы делим свою жизнь.",
    "У каждого своя история — и всё же мы связаны.",
    "Не происхождением, языком или границами — а тем, что мы вместе здесь.",
    "В такие моменты некоторые чувствуют: мы — единое сообщество.",
    "И что нас объединяет больше, чем разделяет.",
    "Бывало ли у тебя такое чувство?",
    "Помоги сделать это чувство видимым."
  ]
};

const tpTexts = TP[LANG] || TP.en;

// Optional: set <html lang="..."> for accessibility
document.documentElement.lang = LANG;

const WORD_MS = 240;
const SENTENCE_PAUSE = 900;

let tpIndex = 0, tpWordIdx = 0, tpTimer = null;
const tpTextEl = document.getElementById("tp-text");
const tpBarEl  = document.getElementById("tp-bar");

function renderSentence(sentence){
  const tokens = sentence.split(/(\s+)/);
  tpTextEl.innerHTML = tokens.map(t => {
    if (/^\s+$/.test(t)) return `<span class="tp-space">${t}</span>`;
    return `<span class="tp-word">${t}</span>`;
  }).join("");
}
function markProgress(activeWordIdx){
  const wordSpans = Array.from(tpTextEl.querySelectorAll(".tp-word"));
  wordSpans.forEach((w, i) => {
    w.classList.remove("active");
    if (i <= activeWordIdx) w.classList.add("done");
    else w.classList.remove("done");
  });
  if (wordSpans[activeWordIdx]) wordSpans[activeWordIdx].classList.add("active");
}
function updateProgress(){
  tpBarEl.style.width = `${100 * (tpIndex + 1) / tpTexts.length}%`;
}
function playSentence(idx, auto=true){
  clearInterval(tpTimer);
  tpIndex = idx; tpWordIdx = 0;
  renderSentence(tpTexts[tpIndex]);
  updateProgress();

  const words = tpTexts[tpIndex].split(/\s+/).filter(Boolean);
  markProgress(0);

  tpTimer = setInterval(() => {
    tpWordIdx++;
    if (tpWordIdx < words.length) markProgress(tpWordIdx);
    else {
      clearInterval(tpTimer);
      markProgress(words.length - 1);
      if(auto){
        setTimeout(() => {
          if(tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, true);
        }, SENTENCE_PAUSE);
      }
    }
  }, WORD_MS);
}
document.getElementById("tp-next").onclick = () => { if(tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, false); };
document.getElementById("tp-prev").onclick = () => { if(tpIndex > 0) playSentence(tpIndex - 1, false); };
playSentence(0, true);

/* -------------------------
   2) SUPABASE
-------------------------- */
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

const SUPABASE_URL = 'https://gwfqdukbcgtcefqtgnbl.supabase.co';  // <-- DEIN Project URL
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3ZnFkdWtiY2d0Y2VmcXRnbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDU2MTMsImV4cCI6MjA4NDI4MTYxM30.ePyuDxhVoc1ol5lQ8JbRKaybgpEPozBR3Wf71oFj040';  // <-- DEIN anon public key

const statusEl = document.getElementById("status");
function setStatus(msg){ statusEl.textContent = msg || ""; }

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let session = localStorage.getItem('myLightSession');
if(!session) { session = uuidv4(); localStorage.setItem('myLightSession', session); }

/* -------------------------
   3) MAP (WICHTIG: zuerst map initialisieren!)
-------------------------- */
const WORLD_BOUNDS = L.latLngBounds(L.latLng(-60, -180), L.latLng(85, 180));
const WORLD_VIEW = { center: [20, 0], zoom: 2.0 };

const map = L.map('map', {
  zoomControl: true,
  preferCanvas: true,
  worldCopyJump: false,
  zoomSnap: 0.25,
  zoomDelta: 0.25,
  maxBounds: WORLD_BOUNDS,
  maxBoundsViscosity: 1.0
}).setView(WORLD_VIEW.center, WORLD_VIEW.zoom);

/* Tile layers (mit/ohne Labels) */
const tileUrlLabels   = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
const tileUrlNoLabels = 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png';
// Alternative heller: 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';

const baseWithLabels = L.tileLayer(tileUrlLabels, {
  attribution: '&copy; OpenStreetMap &copy; CARTO',
  maxZoom: 18,
  noWrap: true,
  bounds: WORLD_BOUNDS,
  crossOrigin: true
}).addTo(map);

const baseNoLabels = L.tileLayer(tileUrlNoLabels, {
  attribution: '&copy; OpenStreetMap &copy; CARTO',
  maxZoom: 18,
  noWrap: true,
  bounds: WORLD_BOUNDS,
  crossOrigin: true
});

/* Lights layer */
const canvasRenderer = L.canvas({ padding: 0.5 });
const lightsLayer = L.layerGroup().addTo(map);

/* sehr kleine Punkte für andere */
function addLight(latlng, isMine=false){
  if(!isMine){
    L.circleMarker(latlng, {
      renderer: canvasRenderer,
      radius: 1.35,
      stroke: false,
      fill: true,
      fillOpacity: 0.70,
      fillColor: "rgba(255,250,245,1)",
      interactive: false
    }).addTo(lightsLayer);
    return;
  }
  // mein Punkt minimal größer
  L.circleMarker(latlng, {
    renderer: canvasRenderer,
    radius: 2.6,
    stroke: false,
    fill: true,
    fillOpacity: 0.95,
    fillColor: "rgba(255,250,245,1)",
    interactive: true
  }).addTo(lightsLayer);
}

let allLightPoints = [];

/* Load */
async function loadLights(){
  try{
    const { data, error } = await sb.from('lights').select('*');
    if(error) throw error;

    allLightPoints = data || [];
    lightsLayer.clearLayers();

    let mine = null;
    for(const row of allLightPoints){
      const isMine = (row.session === session);
      if(isMine) mine = row;
      addLight([row.lat, row.lng], isMine);
    }
    setStatus(mine ? "Dein Licht ist gesetzt. Du kannst es durch Klicken verschieben." : "Setze dein Licht mit einem Klick auf die Karte.");
  } catch(e){
    console.error(e);
    setStatus("Konnte Lichter nicht laden. Prüfe Supabase URL/Key und Tabelle „lights“.");
  }
}

async function loadMyLight(){
  const { data } = await sb.from('lights').select('*').eq('session', session).maybeSingle();
  return data;
}

/* Click: speichern, Zoom bleibt */
map.on('click', async (e) => {
  try{
    const existing = await loadMyLight();
    if(existing){
      await sb.from('lights').update({ lat: e.latlng.lat, lng: e.latlng.lng }).eq('session', session);
    } else {
      await sb.from('lights').insert({ lat: e.latlng.lat, lng: e.latlng.lng, session });
    }
    await loadLights();
  } catch(err){
    console.error(err);
    setStatus("Speichern fehlgeschlagen. Prüfe Supabase-Rechte (RLS/Policies).");
  }
});

/* Weltansicht Button */
document.getElementById("btnWorld").addEventListener("click", () => {
  map.setView(WORLD_VIEW.center, WORLD_VIEW.zoom, { animate: true });
});

/* Export: Screenshot der Weltansicht, kurz ohne Labels */
function waitTiles(layer){
  return new Promise(resolve => {
    let done = false;
    const finish = () => {
      if(done) return;
      done = true;
      requestAnimationFrame(() => requestAnimationFrame(resolve));
    };
    layer.once('load', finish);
    setTimeout(finish, 1200); // Fallback
  });
}

document.getElementById("btnCard").addEventListener("click", async () => {
  try{
    setStatus("Erzeuge Screenshot…");

    // 1) auf Weltansicht
    map.setView(WORLD_VIEW.center, WORLD_VIEW.zoom, { animate: true });

    // 2) no-labels Layer rein
    if(map.hasLayer(baseWithLabels)) map.removeLayer(baseWithLabels);
    baseNoLabels.addTo(map);

    // 3) warten bis Tiles geladen
    await waitTiles(baseNoLabels);

    // 4) Screenshot
    leafletImage(map, function(err, canvas){
      // 5) Layer zurück
      map.removeLayer(baseNoLabels);
      baseWithLabels.addTo(map);

      if(err){
        console.error(err);
        setStatus("Export fehlgeschlagen.");
        alert("Export fehlgeschlagen.");
        return;
      }
      const png = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = png;
      a.download = "weltansicht-ohne-labels.png";
      a.click();
      setStatus("Fertig.");
    });
  } catch(e){
    console.error(e);
    setStatus("Export fehlgeschlagen.");
    alert("Export fehlgeschlagen.");
  }
});

/* Start */
loadLights();
setInterval(loadLights, 30000);
</script>
</body>
</html>
