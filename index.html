<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Together We Are One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- PNG Export helper -->
  <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Together We Are One">
  <meta property="og:description" content="A quiet place. You set a light and see that many feel the same.">
  <meta property="og:image" content="https://togetherweareone.earth/TogetherWeAreOneEarth.jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="1200">
  <meta property="og:url" content="https://togetherweareone.earth/">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://togetherweareone.earth/TogetherWeAreOneEarth.jpeg">

  <style>
:root{
  --bg0:#0b0d12;
  --bg1:#121526;
  --card: rgba(255,255,255,0.06);
  --card2: rgba(255,255,255,0.08);
  --stroke: rgba(255,255,255,0.10);
  --ghost: rgba(255,255,255,0.25);
  --text: rgba(255,255,255,0.92);
  --warm: rgba(255,220,170,0.95);
  --shade-opacity: 0.10;
  --map-brightness: 0.65;
  --map-contrast: 1.0;
  --map-saturate: 0.0;
}

.leaflet-tile{
  filter:
    grayscale(1)
    brightness(var(--map-brightness))
    contrast(var(--map-contrast))
    saturate(var(--map-saturate));
}

html{ margin:0; }
body{
  margin:0;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg0));
  font-family:system-ui,-apple-system,"Inter",sans-serif;
  min-height:100dvh;
  display:flex;
  flex-direction:column;
}

/* Layout */
.wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:20px 16px;
}
.content{
  flex:1;
  width:100%;
  max-width:1000px;
  margin:0 auto;

  display:grid;
  grid-template-rows:auto 1fr auto;
  gap:18px;

  min-height:0;
}

/* Cards */
.teleprompter{
  position:relative;
  padding:16px 20px;
  backdrop-filter:blur(20px);
  background:linear-gradient(
    180deg,
    rgba(255,255,255,0.05),
    rgba(255,255,255,0.02)
  );
}

.mapWrap{
  position:relative;
  overflow:hidden;
  background:#0a0b10;
  display:flex;
  min-height:320px;
}

.mapTint,
.mapShade{
  pointer-events:none;
  position:absolute;
  inset:0;
  z-index:2;
}

.mapTint{
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.05), rgba(0,0,0,0.35));
  mix-blend-mode:multiply;
}
.mapShade{
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.0), rgba(0,0,0,0.55));
}

/* Map */
#map{ flex:1; }

.status,
.hint,
.privacy-hint{
  font-size:13px;
  opacity:0.65;
  margin:4px 0;
}

.hint{
  position:sticky;
  bottom:10px;
}

.leaflet-container{
  background:#0a0b10 !important;
  cursor:crosshair;
}

/* Subtiles Nacht-Softening */
.mapDarkOverlay{
  pointer-events:none;
  position:absolute;
  inset:0;
  z-index:1;
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.05), rgba(0,0,0,0.15));
}

/* Center Control */
.mapCenterControl{
  position:absolute;
  top:25px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
}

.world-btn{
  padding:8px 18px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.28);
  color:white;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s ease;
}
.world-btn:hover{
  background:rgba(255,220,170,0.12);
  border:1px solid rgba(255,220,170,0.35);
}

/* Teleprompter */
.tp-text{
  text-align:center;
  font-size:clamp(16px, 2vw, 24px);
  line-height:1.35;
  min-height:1.8em;
}
.tp-word{ color:var(--ghost); transition:0.2s; }
.tp-word.done{ color:var(--warm); }
.tp-word.active{ color:white; }

.tp-meta{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  margin-top:6px;
}

.tp-btn{
  background:transparent;
  border:none;
  opacity:0.5;
  padding:6px 10px;
  color: inherit;
}
.tp-btn:hover{ opacity:1; }

.tp-progress{
  width:min(500px, 60vw);
  height:4px;
  border-radius:6px;
  overflow:hidden;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.08);
  flex:0 1 420px;
}

.tp-progress-bar{
  height:4px;
  width:0%;
  background: linear-gradient(90deg, rgba(255,220,170,0.7), rgba(255,255,255,0.6));
  transition: width 0.6s cubic-bezier(.4,0,.2,1);
}

.tp-actions{
  margin-top:14px;
  min-height:0;
  position:relative;
}
.tp-actions-center{ text-align:center; }
.tp-actions-right{
  position:absolute;
  right:0;
  top:0;
}

.share-btn{
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.12);
  padding:8px 18px;
  font-size:14px;
  border-radius:999px;
  font-weight:500;
  letter-spacing:0.02em;
}

.export-btn{
  background:rgba(255,220,170,0.15);
  border:1px solid rgba(255,220,170,0.35);
  position:absolute;
  bottom:14px;
  right:14px;
  padding:6px 10px;
  font-size:12px;
  border-radius:10px;
  opacity:0.6;
}

/* Footer text */
.status,
.hint,
.privacy-hint{
  text-align:center;
  margin-top:14px;
  font-size:14px;
  opacity:0.7;
}

/* Attribution */
.leaflet-control-attribution{
  background:rgba(0,0,0,0.35) !important;
  color:rgba(255,255,255,0.65);
}

/* Lang badge */
#langBadge{
  position:fixed;
  top:15px;
  left:15px;
  font-size:12px;
  opacity:0.6;
  z-index:2000;
}
  </style>
</head>

<body>

<!-- FIX: existiert jetzt wirklich -->
<div id="langBadge"></div>

<div class="wrap">
  <div class="content">

    <!-- TELEPROMPTER -->
    <div class="teleprompter">
      <p id="tp-text" class="tp-text"></p>

      <div class="tp-meta">
        <button id="tp-prev" class="tp-btn" type="button">←</button>

        <div class="tp-progress">
          <div class="tp-progress-bar" id="tp-bar"></div>
        </div>

        <button id="tp-next" class="tp-btn" type="button">→</button>
      </div>

      <div class="tp-actions">
        <div class="tp-actions-center">
          <button id="shareMain" class="tp-btn share-btn" type="button"></button>
        </div>
        <div class="tp-actions-right">
          <button id="btnCard" class="tp-btn export-btn" type="button"></button>
        </div>
      </div>
    </div>

    <!-- KARTE -->
    <div class="mapWrap">
      <div class="mapCenterControl">
        <button id="btnWorld" class="world-btn" type="button"></button>
      </div>

      <div id="map"></div>

      <!-- FIX: overlay existiert jetzt -->
      <div class="mapDarkOverlay"></div>

      <div class="mapTint"></div>
      <div class="mapShade"></div>
    </div>

    <!-- Footer -->
    <p id="privacyHint" class="privacy-hint"></p>
    <p id="status" class="status"></p>
    <p id="hint" class="hint"></p>

  </div>
</div>

<script>
/* -------------------------
   1) Language Detection
-------------------------- */
function getLangFromUrl() {
  const p = new URLSearchParams(location.search);
  const v = (p.get("lang") || "").trim();
  return v ? v.toLowerCase() : null;
}
function normalizeLang(tag) {
  if (!tag) return "en";
  const t = tag.toLowerCase();
  if (t.startsWith("zh")) return "zh";
  if (t.startsWith("in")) return "id";
  if (t.startsWith("iw")) return "he";
  if (t.startsWith("pt")) return "pt";
  return t.split("-")[0];
}
const SUPPORTED = [
  "en","de","es","fr","pt","ru","ar","hi",
  "bn","ur","zh","ja","ko","vi","tr","sw","id"
];
function pickLanguage() {
  const urlLang = normalizeLang(getLangFromUrl());
  if (urlLang && SUPPORTED.includes(urlLang)) return urlLang;

  const prefs = (navigator.languages && navigator.languages.length)
    ? navigator.languages.map(normalizeLang)
    : [normalizeLang(navigator.language || "en")];

  for (const lang of prefs) {
    if (SUPPORTED.includes(lang)) return lang;
  }
  return "en";
}
const LANG = pickLanguage();
document.documentElement.lang = LANG;
const lb = document.getElementById("langBadge");
if (lb) lb.textContent = LANG.toUpperCase();

/* -------------------------
   2) Teleprompter Text
-------------------------- */
const TP = {
  en: [
    "We almost never think about it.",
    "Our lives on this small blue planet in space.",
    "In this brief blink long after the Big Bang.",
    "That it exists at all – as far as we know – is unique.",
    "That makes us all special. And it connects us.",
    "Here you can place a light. And see that many feel the same."
  ],
  de: [
    "Wir denken fast nie daran.",
    "Unser Leben auf dieser kleinen blauen Kugel im Weltall.",
    "In diesem Augenzwinkern lange nach dem Urknall.",
    "Dass es das überhaupt gibt – nach allem was wir wissen – ist einzigartig.",
    "Das macht uns alle besonders. Und es verbindet uns.",
    "Hier kannst du ein Licht setzen. Und sehen, dass viele dasselbe fühlen."
  ],
  es: [
    "Casi nunca pensamos en ello.",
    "Nuestra vida en esta pequeña esfera azul en el espacio.",
    "En este parpadeo fugaz mucho después del Big Bang.",
    "Que exista – según todo lo que sabemos – es único.",
    "Eso nos hace especiales a todos. Y nos conecta.",
    "Aquí puedes colocar una luz. Y ver que muchos sienten lo mismo."
  ],
  fr: [
    "Nous n’y pensons presque jamais.",
    "À notre vie sur cette petite planète bleue dans l’espace.",
    "Dans ce clin d’œil fugace longtemps après le Big Bang.",
    "Le fait que cela existe – selon ce que nous savons – est unique.",
    "Cela nous rend tous particuliers. Et nous relie.",
    "Ici, tu peux placer une lumière. Et voir que beaucoup ressentent la même chose."
  ]
};

/* -------------------------
   3) UI Text
-------------------------- */
const UI = {
  en: {
    world: "World view",
    card: "Generate map",
    hint: "Click on the map to place or move your light. (One light per browser.)",
    privacy: "Lights are anonymous and rounded to about 10 km.",
    status_empty: "Place your light by clicking on the map.",
    status_set: "Your light is set. You can move it by clicking on the map.",
    status_export: "Creating image…",
    status_done: "Done.",
    status_error_load: "Could not load lights.",
    status_error_save: "Could not save image."
  },
  de: {
    world: "Weltansicht",
    card: "Karte generieren",
    hint: "Klicke auf die Karte, um dein Licht zu setzen oder zu verschieben.",
    privacy: "Lichter sind anonym und auf etwa 10 km gerundet.",
    status_empty: "Setze dein Licht mit einem Klick.",
    status_set: "Dein Licht ist gesetzt.",
    status_export: "Erzeuge Bild…",
    status_done: "Fertig.",
    status_error_load: "Lichter konnten nicht geladen werden.",
    status_error_save: "Bild konnte nicht gespeichert werden."
  },
  es: {
    world: "Vista mundial",
    card: "Generar mapa",
    hint: "Haz clic en el mapa para colocar o mover tu luz.",
    privacy: "Las luces son anónimas y redondeadas a unos 10 km.",
    status_empty: "Coloca tu luz haciendo clic.",
    status_set: "Tu luz está colocada.",
    status_export: "Creando imagen…",
    status_done: "Listo.",
    status_error_load: "No se pudieron cargar las luces.",
    status_error_save: "No se pudo guardar la imagen."
  },
  fr: {
    world: "Vue du monde",
    card: "Générer la carte",
    hint: "Cliquez sur la carte pour placer ou déplacer votre lumière.",
    privacy: "Les lumières sont anonymes et arrondies à environ 10 km.",
    status_empty: "Placez votre lumière.",
    status_set: "Votre lumière est placée.",
    status_export: "Création de l’image…",
    status_done: "Terminé.",
    status_error_load: "Impossible de charger les lumières.",
    status_error_save: "Impossible d’enregistrer l’image."
  }
};

const UI_TEXT = UI[LANG] || UI.en;
const tpTexts = TP[LANG] || TP.en;

document.getElementById("btnWorld").textContent = UI_TEXT.world;
document.getElementById("btnCard").textContent  = UI_TEXT.card;
document.getElementById("hint").textContent     = UI_TEXT.hint;
document.getElementById("privacyHint").textContent = UI_TEXT.privacy;

/* -------------------------
   4) Teleprompter
-------------------------- */
const CHAR_BASED_LANGS = ["zh","ja","ko"];
const WORD_MS = (CHAR_BASED_LANGS.includes(LANG) ? 190 : 240);
const SENTENCE_PAUSE = 900;

let tpIndex = 0;
let tpUnitIdx = 0;
let tpTimer = null;

const tpTextEl = document.getElementById("tp-text");
const tpBarEl  = document.getElementById("tp-bar");

function updateProgress(){
  if(!tpBarEl) return;
  tpBarEl.style.width = `${100 * (tpIndex + 1) / tpTexts.length}%`;
}

function renderSentence(sentence){
  const s = (sentence || "").replace(/\n/g, " \n ");
  const tokens = s.split(/(\s+)/);

  tpTextEl.innerHTML = tokens.map(t => {
    if (t === "\n") return `<span class="tp-br"></span>`;
    if (/^\s+$/.test(t)) return `<span class="tp-space">${t}</span>`;
    return `<span class="tp-word">${t}</span>`;
  }).join("");
}

function getUnits(sentence){
  const s = sentence || "";
  if (CHAR_BASED_LANGS.includes(LANG)) {
    return Array.from(s.replace(/\s+/g, ""));
  }
  return s.replace(/\n/g, " ").split(/\s+/).filter(Boolean);
}

function markProgress(activeIdx){
  const wordSpans = Array.from(tpTextEl.querySelectorAll(".tp-word"));
  wordSpans.forEach((w, i) => {
    w.classList.remove("active");
    if (i <= activeIdx) w.classList.add("done");
    else w.classList.remove("done");
  });
  if (wordSpans[activeIdx]) wordSpans[activeIdx].classList.add("active");
}

function playSentence(idx, auto=true){
  clearInterval(tpTimer);
  tpIndex = idx;
  tpUnitIdx = 0;

  renderSentence(tpTexts[tpIndex]);
  updateProgress();
  const units = getUnits(tpTexts[tpIndex]);
  markProgress(0);

  tpTimer = setInterval(() => {
    tpUnitIdx++;
    if (tpUnitIdx < units.length) {
      markProgress(tpUnitIdx);
    } else {
      clearInterval(tpTimer);
      markProgress(Math.max(0, units.length - 1));
      if (auto) {
        setTimeout(() => {
          if (tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, true);
        }, SENTENCE_PAUSE);
      }
    }
  }, WORD_MS);
}

document.getElementById("tp-prev").addEventListener("click", () => {
  if (tpIndex > 0) playSentence(tpIndex - 1, false);
});
document.getElementById("tp-next").addEventListener("click", () => {
  if (tpIndex < tpTexts.length - 1) playSentence(tpIndex + 1, false);
});
playSentence(0, true);

/* -------------------------
   5) Share
-------------------------- */
const SHARE_MAIN_LABEL = {
  de: "Mit einer Freundin oder einem Freund teilen",
  en: "Share with a friend",
  fr: "Partager avec un ami",
  es: "Compartir con un amigo",
  pt: "Compartilhar com um amigo",
  ru: "Поделиться с другом",
  ar: "شارك مع صديق",
  hi: "किसी दोस्त के साथ साझा करें",
  bn: "একজন বন্ধুর সাথে শেয়ার করুন",
  ur: "کسی دوست کے ساتھ شیئر کریں",
  zh: "分享给朋友",
  ja: "友だちと共有する",
  ko: "친구와 공유하기",
  vi: "Chia sẻ với một người bạn",
  tr: "Bir arkadaşınla paylaş",
  sw: "Shiriki na rafiki",
  id: "Bagikan dengan seorang teman"
};

const SHARE_TEXT = {
  de: "Eine stille Seite. Man setzt ein Licht und sieht, dass viele dasselbe fühlen.",
  en: "A quiet place. You set a light and see that many feel the same.",
  es: "Un lugar tranquilo. Pones una luz y ves que muchos sienten lo mismo.",
  fr: "Un endroit calme. On y place une lumière et on voit que beaucoup ressentent la même chose.",
  pt: "Um lugar tranquilo. Você coloca uma luz e vê que muitos sentem o mesmo.",
  ru: "Тихое место. Ты зажигаешь свет и видишь, что многие чувствуют то же самое.",
  ar: "مكان هادئ. تضع نورًا وترى أن كثيرين يشعرون بالشيء نفسه.",
  hi: "एक शांत जगह। आप एक रोशनी रखते हैं और देखते हैं कि बहुत से लोग वही महसूस करते हैं।",
  bn: "একটি শান্ত জায়গা। তুমি একটি আলো বসাও এবং দেখো যে অনেকেই একই অনুভব করে।",
  ur: "ایک خاموش جگہ۔ آپ ایک روشنی رکھتے ہیں اور دیکھتے ہیں کہ بہت سے لوگ وہی محسوس کرتے ہیں۔",
  zh: "一个安静的地方。你点亮一盏灯，看到许多人有着相同的感受。",
  ja: "静かな場所。光を置くと、同じように感じている人がたくさんいることがわかります。",
  ko: "조용한 공간. 빛을 놓으면 많은 사람들이 같은 감정을 느끼고 있음을 볼 수 있습니다.",
  vi: "Một nơi yên tĩnh. Bạn đặt một ánh sáng và thấy rằng nhiều người cũng cảm nhận như vậy.",
  tr: "Sessiz bir yer. Bir ışık bırakırsın ve birçok kişinin aynı şeyi hissettiğini görürsün.",
  sw: "Mahali tulivu. Unaweka mwanga na kuona kwamba wengi wanahisi vivyo hivyo.",
  id: "Tempat yang tenang. Kamu menempatkan sebuah cahaya dan melihat bahwa banyak yang merasakan hal yang sama."
};

function shareUrlForLang() {
  return `${location.origin}/?lang=${encodeURIComponent(LANG)}`;
}

function ensureShareButton(){

  const btn = document.getElementById("shareMain");
  if (!btn) return;

  btn.textContent = SHARE_MAIN_LABEL[LANG] || SHARE_MAIN_LABEL.en;

  btn.addEventListener("click", async () => {

    const url  = shareUrlForLang();
    const text = SHARE_TEXT[LANG] || SHARE_TEXT.en;
    const title = UI_TEXT.share_title || "Together We Are One";

    // Native share (Mobile / modern browsers)
    if (navigator.share) {
      try {
        await navigator.share({
          title,
          text,
          url
        });
        return;
      } catch (err) {
        // user cancelled → no fallback needed
        if (err && err.name === "AbortError") return;
      }
    }

    // Clipboard fallback
    try {
      await navigator.clipboard.writeText(url);
      setStatus("copy_ok");
      return;
    } catch (_) {}

    // Last fallback (older browsers)
    window.prompt("", url);
  });
}

ensureShareButton();

/* -------------------------
   6) Supabase + Status
-------------------------- */
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

const SUPABASE_URL = 'https://gwfqdukbcgtcefqtgnbl.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3ZnFkdWtiY2d0Y2VmcXRnbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDU2MTMsImV4cCI6MjA4NDI4MTYxM30.ePyuDxhVoc1ol5lQ8JbRKaybgpEPozBR3Wf71oFj040';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let session = localStorage.getItem('myLightSession');
if(!session){
  session = uuidv4();
  localStorage.setItem('myLightSession', session);
}

const statusEl = document.getElementById("status");
function setStatus(key){
  const v = UI_TEXT[key] || key || "";
  if (statusEl) statusEl.textContent = v;
}

/* -------------------------
   7) Map
-------------------------- */
const WORLD_BOUNDS = L.latLngBounds(L.latLng(-60, -180), L.latLng(85, 180));
const WORLD_VIEW = { center: [20, 0], zoom: 2.0 };

function afterTwoFrames(fn){ requestAnimationFrame(() => requestAnimationFrame(fn)); }

const map = L.map('map', {
  zoomControl: true,
  preferCanvas: true,
  worldCopyJump: false,
  zoomSnap: 0.25,
  zoomDelta: 0.25,
  maxBounds: WORLD_BOUNDS,
  maxBoundsViscosity: 1.0
});

const canvasRenderer = L.canvas({ padding: 0.5 });
const lightsLayer = L.layerGroup().addTo(map);

function addLight(latlng, isMine=false){
  L.circleMarker(latlng, {
    renderer: canvasRenderer,
    radius: isMine ? 2.6 : 1.35,
    stroke: false,
    fill: true,
    fillOpacity: isMine ? 0.95 : 0.70,
    fillColor: "rgba(255,250,245,1)",
    interactive: isMine
  }).addTo(lightsLayer);
}

map.setView(WORLD_VIEW.center, WORLD_VIEW.zoom, { animate: false });
function goWorld(){ map.setView(WORLD_VIEW.center, WORLD_VIEW.zoom, { animate: false }); }

map.whenReady(() => {
  afterTwoFrames(() => {
    map.invalidateSize(true);
    goWorld();
  });
});
window.addEventListener("pageshow", () => {
  afterTwoFrames(() => {
    map.invalidateSize(true);
    goWorld();
  });
});

let _resizeT = null;
window.addEventListener("resize", () => {
  clearTimeout(_resizeT);
  _resizeT = setTimeout(() => map.invalidateSize(true), 150);
});

const voyagerTiles = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 18, noWrap: true, bounds: WORLD_BOUNDS, crossOrigin: true }
).addTo(map);

const exportTiles = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 18, noWrap: true, bounds: WORLD_BOUNDS, crossOrigin: true }
);

let myExactLatLng = null;

function anonymize(lat, lng) {
  const GRID = 0.1;
  return { lat: Math.round(lat / GRID) * GRID, lng: Math.round(lng / GRID) * GRID };
}

const ghost = L.circleMarker([0,0], { radius: 10, stroke: false, fill: true, fillOpacity: 0.0, fillColor: "rgba(255,220,170,1)", interactive: false }).addTo(map);
const ghostCore = L.circleMarker([0,0], { radius: 2.2, stroke: false, fill: true, fillOpacity: 0.0, fillColor: "rgba(255,250,245,1)", interactive: false }).addTo(map);

map.on("mouseover", () => { ghost.setStyle({ fillOpacity: 0.10 }); ghostCore.setStyle({ fillOpacity: 0.75 }); });
map.on("mouseout",  () => { ghost.setStyle({ fillOpacity: 0.0  }); ghostCore.setStyle({ fillOpacity: 0.0  }); });
map.on("mousemove", (e) => { ghost.setLatLng(e.latlng); ghostCore.setLatLng(e.latlng); });

async function loadMyLight(){
  const { data } = await sb.from('lights').select('*').eq('session', session).maybeSingle();
  return data;
}

let allLightPoints = [];

async function loadLights(){
  try{
    const { data, error } = await sb.from('lights').select('*');
    if(error) throw error;

    lightsLayer.clearLayers();

    let mine = null;
    for(const row of (data || [])){
      const isMine = (row.session === session);
      if(isMine) mine = row;

      if (isMine && myExactLatLng) addLight([myExactLatLng.lat, myExactLatLng.lng], true);
      else addLight([row.lat, row.lng], isMine);
    }

    allLightPoints = data || [];

    const hintEl = document.getElementById("hint");
    if (mine) {
      if (hintEl) hintEl.style.display = "none";
      setStatus("status_set");
    } else {
      if (hintEl) hintEl.style.display = "block";
      setStatus("status_empty");
    }

  }catch(e){
    console.error(e);
    setStatus("status_error_load");
  }
}

map.on('click', async (e) => {
  try {
    const clickedLatLng = e.latlng;
    const anonymized = anonymize(clickedLatLng.lat, clickedLatLng.lng);
    myExactLatLng = clickedLatLng;

    const existing = await loadMyLight();

    if(existing){
      await sb.from('lights').update({ lat: anonymized.lat, lng: anonymized.lng }).eq('session', session);
    } else {
      await sb.from('lights').insert({ lat: anonymized.lat, lng: anonymized.lng, session });
    }

    await loadLights();
  } catch(err){
    console.error(err);
  }
});

document.getElementById("btnWorld").addEventListener("click", () => { goWorld(); });

/* -------------------------
   8) Export
-------------------------- */
function waitMoveEnd(m) {
  return new Promise(resolve => {
    let done = false;
    const finish = () => {
      if(done) return;
      done = true;
      m.off("moveend", finish);
      resolve();
    };
    m.once("moveend", finish);
    setTimeout(finish, 450);
  });
}

function waitTiles(layer){
  return new Promise(resolve => {
    let done = false;
    const finish = () => {
      if(done) return;
      done = true;
      layer.off("load", finish);
      requestAnimationFrame(() => requestAnimationFrame(resolve));
    };
    layer.once("load", finish);
    setTimeout(finish, 1800);
  });
}

document.getElementById("btnCard").addEventListener("click", async () => {
  try {
    setStatus("status_export");

    goWorld();
    await waitMoveEnd(map);

    if (map.hasLayer(voyagerTiles)) map.removeLayer(voyagerTiles);
    exportTiles.addTo(map);
    await waitTiles(exportTiles);

    map.removeLayer(lightsLayer);

    const exportLayer = L.layerGroup();
    for (const row of allLightPoints) {
      const isMine = row.session === session;
      L.circleMarker([row.lat, row.lng], {
        radius: isMine ? 2.6 : 1.35,
        stroke: false,
        fill: true,
        fillOpacity: isMine ? 0.95 : 0.70,
        fillColor: "rgba(255,250,245,1)"
      }).addTo(exportLayer);
    }
    exportLayer.addTo(map);

    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    const tiles = document.querySelectorAll(".leaflet-tile");
    tiles.forEach(t => t.style.filter = "none");

    const overlay = document.querySelector(".mapDarkOverlay");
    if (overlay) overlay.style.display = "none";

    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    leafletImage(map, function(err, canvas){
      tiles.forEach(t => t.style.filter = "");
      if (overlay) overlay.style.display = "";

      map.removeLayer(exportLayer);
      lightsLayer.addTo(map);
      map.removeLayer(exportTiles);
      voyagerTiles.addTo(map);

      if(err){
        console.error(err);
        setStatus("status_error_save");
        return;
      }

      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "together-we-are-one.png";
      link.click();

      setStatus("status_done");
    });

  } catch(e){
    console.error(e);
    setStatus("status_error_save");
  }
});

/* -------------------------
   9) Start
-------------------------- */
loadLights();
setInterval(loadLights, 30000);
</script>
</body>
</html>
