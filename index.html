<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Together We Are One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #101014; color: #fafafa;}
    .teleprompter {
      max-width: 520px;
      margin: 32px auto 18px auto;
      background: rgba(36,34,28,0.97);
      border-radius: 18px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.19);
      padding: 20px 26px 16px 26px;
      font-size: 1.18em;
      color: #ffe9c2;
      min-height: 60px;
      position: relative;
      text-align: center;
      letter-spacing: 0.01em;
      line-height: 1.5;
    }
    .tp-text { min-height: 1.8em; transition: color 0.2s;text-align: left;}
    .tp-word {
  opacity: 0.35;
  color: #ffe9c2;
  font-weight: 400;
  transition: opacity 0.18s, color 0.18s, background 0.18s;
  white-space: pre;          /* hält Leerzeichen stabil */
}
.tp-word.active {
  opacity: 1;
  color: #fff9e4;
  font-weight: 600;
  background: rgba(255, 230, 164, 0.18);
  border-radius: 6px;
  /* KEIN font-size hier! */
}
    .tp-controls {
      display: flex; align-items: center; justify-content: center;
      margin-top: 13px; user-select: none; gap: 10px;
    }
    .tp-controls button {
      background: none;
      border: none;
      color: #ffd670;
      font-size: 1.65em;
      cursor: pointer;
      border-radius: 50%;
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, color 0.2s;
    }
    .tp-controls button:active { background: #ffd67022; color: #fff4d4;}
    .tp-progress {
      flex: 1;
      height: 6px;
      margin: 0 12px;
      border-radius: 5px;
      background: #3b3535;
      overflow: hidden;
      position: relative;
      top: 0.5em;
    }
    .tp-progress-bar {
      height: 100%;
      background: linear-gradient(90deg,#ffe397,#ffd64d 85%);
      transition: width 0.32s;
    }
    #map { width: 100vw; height: 60vh; max-height: 420px; border-radius: 18px; box-shadow: 0 2px 14px rgba(0,0,0,0.25);}
    .hint {text-align:center; font-size: 1.1em; color: #ddd; margin-top: 20px;}
    @media (max-width: 600px) {
      .teleprompter {margin: 12px 4px 10px 4px; padding: 9px;}
      #map {height: 44vh;}
    }
  </style>
</head>
<body>
  <div class="teleprompter" id="teleprompter">
  <div class="tp-text" id="tp-text"></div>
  <div class="tp-controls">
    <button id="tp-prev" title="Zurück">&#8592;</button>
    <div class="tp-progress" id="tp-progress"><div class="tp-progress-bar"></div></div>
    <button id="tp-next" title="Weiter">&#8594;</button>
  </div>
  </div> 
  <div id="map"></div>
  <div class="hint" id="hint">Klicke auf die Karte, um dein Licht zu setzen oder zu verschieben. (Nur ein Licht pro Browser.)</div>
  <script>
    // -------- Teleprompter-Text-Array (nur Deutsch, beliebig anpassbar) ----
    const tpTexts = [
  "Manchmal schauen wir in den Himmel.",
  "Vielleicht sehen wir einen Stern, den Mond, ferne Galaxien.",
  "Für einen Moment wird uns bewusst, wie klein unser Planet ist.",
  "Wie selten – vielleicht sogar einzigartig – das Leben hier ist.",
  "Auf diesem winzigen Punkt im Weltall teilen wir unser Leben.",
  "Jeder von uns mit einer eigenen Geschichte, aber doch alle miteinander verbunden.",
  "Nicht durch Herkunft, Sprache oder Grenzen – sondern durch das Glück, gemeinsam hier zu sein.",
  "Manche Menschen spüren in solchen Momenten, dass wir eigentlich eine einzige Gemeinschaft sind.",
  "Dass uns mehr verbindet als trennt.",
  "Hast du das auch schon einmal gefühlt?",
  "Helf’ uns, dieses Gefühl sichtbar zu machen!"
];

const WORD_MS = 340;
const SENTENCE_PAUSE = 1100;

let tpIndex = 0;
let tpWordIdx = 0;
let tpTimer = null;

const tpTextEl = document.getElementById("tp-text");
const tpProgress = document.getElementById("tp-progress");

function renderSentence(sentence){
  // Wichtig: Wir rendern ALLE Wörter sofort, damit nichts "wandert"
  const parts = sentence.split(" ");

  tpTextEl.innerHTML = parts.map((w,i) => {
    // Leerzeichen bewusst als Text drin lassen, damit Layout stabil bleibt
    const trailingSpace = (i < parts.length - 1) ? " " : "";
    return `<span class="tp-word" data-i="${i}">${w}${trailingSpace}</span>`;
  }).join("");

  tpWordIdx = 0;
  highlightWord();
}

function highlightWord(){
  const words = tpTextEl.querySelectorAll(".tp-word");
  words.forEach((el,i) => el.classList.toggle("active", i === tpWordIdx));
}

function updateProgress(){
  tpProgress.innerHTML =
    `<div class="tp-progress-bar" style="width:${100*(tpIndex+1)/tpTexts.length}%"></div>`;
}

function step(){
  const words = tpTextEl.querySelectorAll(".tp-word");
  if(tpWordIdx < words.length - 1){
    tpWordIdx++;
    highlightWord();
    return;
  }

  // Satz fertig -> Pause -> nächster Satz
  clearInterval(tpTimer);
  setTimeout(() => {
    if(tpIndex < tpTexts.length - 1){
      tpIndex++;
      show(tpIndex);
    }
  }, SENTENCE_PAUSE);
}

function show(idx){
  tpIndex = idx;
  updateProgress();
  renderSentence(tpTexts[tpIndex]);

  clearInterval(tpTimer);
  tpTimer = setInterval(step, WORD_MS);
}

// Buttons
document.getElementById("tp-next").onclick = () => {
  if(tpIndex < tpTexts.length - 1) show(tpIndex + 1);
};
document.getElementById("tp-prev").onclick = () => {
  if(tpIndex > 0) show(tpIndex - 1);
};

// Start
show(0);

    // --------- Der Rest: Map und Supabase wie gehabt ----------

    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    const SUPABASE_URL = 'https://gwfqdukbcgtcefqtgnbl.supabase.co';  // <-- DEIN Project URL aus Supabase!
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3ZnFkdWtiY2d0Y2VmcXRnbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDU2MTMsImV4cCI6MjA4NDI4MTYxM30.ePyuDxhVoc1ol5lQ8JbRKaybgpEPozBR3Wf71oFj040';  // <-- DEIN anon public key!

    const candleIcon = L.icon({
      iconUrl: 'https://openmoji.org/data/color/svg/1F56F.svg',
      iconSize: [32, 40],
      iconAnchor: [16, 38],
      popupAnchor: [0, -34]
    });

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let session = localStorage.getItem('myLightSession');
    if(!session) {
      session = uuidv4();
      localStorage.setItem('myLightSession', session);
    }
    const map = L.map('map', { zoomControl: true }).setView([20, 0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors & CartoDB',
      maxZoom: 18,
    }).addTo(map);

    let allMarkers = [];
    let myMarker = null;
    async function loadLights() {
      allMarkers.forEach(m => map.removeLayer(m));
      allMarkers = [];
      myMarker = null;
      let { data, error } = await sb.from('lights').select('*');
      if(data) {
        data.forEach(row => {
          const icon = candleIcon;
          const marker = L.marker([row.lat, row.lng], {icon, interactive: row.session === session});
          if(row.session === session) {
            marker.bindPopup("Helf’ uns, dieses Gefühl sichtbar zu machen!").openPopup();
            myMarker = marker;
          }
          allMarkers.push(marker);
          marker.addTo(map);
        });
      }
    }
    async function loadMyLight() {
      let { data } = await sb.from('lights').select('*').eq('session', session).maybeSingle();
      return data;
    }
    map.on('click', async function(e) {
      let existing = await loadMyLight();
      if(existing) {
        await sb.from('lights').update({lat: e.latlng.lat, lng: e.latlng.lng}).eq('session', session);
      } else {
        await sb.from('lights').insert({lat: e.latlng.lat, lng: e.latlng.lng, session});
      }
      await loadLights();
    });
    loadLights();
    setInterval(loadLights, 30000);
  </script>
</body>
</html>
